
music_list = {
    { name = "alchemist_1", duration = 42},
    { name = "alchemist_2", duration = 48},
    { name = "death_note_op_1", duration = 34},
    { name = "death_note_op_2", duration = 51},
    { name = "death_note_op_3", duration = 56},
    { name = "loli_mou_1", duration = 32},
    { name = "loli_mou_2", duration = 32},
    { name = "naruto_op_1", duration = 38},
    { name = "naruto_op_2", duration = 42},
    { name = "niletto_lubimka", duration = 32},
    { name = "parasyte_speak_1", duration = 40},
    { name = "parasyte_speak_2", duration = 42},
    { name = "parasyte_theme_1", duration = 41},
    { name = "parasyte_theme_2", duration = 43},
    { name = "fly_mach", duration = 41},
    { name = "jojo_op_1", duration = 58},
    { name = "jojo_op_2", duration = 54},
    { name = "igor_doroga1", duration = 26},
    { name = "igor_doroga2", duration = 25},
    { name = "igor_doroga3", duration = 30},
    { name = "igor_doroga4", duration = 26},    
    { name = "gluttony_music", duration = 32},
    { name = "envy_music", duration = 25},
    { name = "pride_music", duration = 43},
    { name = "greed_music", duration = 32},
    { name = "lust_music", duration = 25},
    { name = "sloth_music", duration = 41},
    { name = "roshan_def.wd_dance", duration = 8},
    { name = "dyadya_vova1", duration = 51},
    { name = "dyadya_vova2", duration = 38},
    { name = "dyadya_vova3", duration = 43},
    { name = "stalker_bandit", duration = 43},
    { name = "spulae_mulae", duration = 36},
    { name = "glad_valakas", duration = 28},
    { name = "undertale", duration = 19},
    { name = "pivko", duration = 24},
    { name = "totoro_theme", duration = 31},
-- NEW 2023_08_13
    { name = "black_summoner_1", duration = 31},
    { name = "black_summoner_2", duration = 57},
    { name = "bleach_velonica_1", duration = 46},
    { name = "bleach_velonica_2", duration = 44},
    { name = "blood_blockade_battlefront_ending_1", duration = 46},
    { name = "blood_blockade_battlefront_ending_2", duration = 41},
    { name = "blood_blockade_battlefront_op_1", duration = 43},
    { name = "blood_blockade_battlefront_op_2", duration = 45},
    { name = "bump_of_chicken_answer_1", duration = 59},
    { name = "bump_of_chicken_answer_2", duration = 58},
    { name = "bump_of_chicken_answer_3", duration = 57},
    { name = "casey_edwards_bury_the_light", duration = 41},
    { name = "chainsaw_man_opening_1", duration = 35},
    { name = "chainsaw_man_opening_2", duration = 51},
    { name = "cyua_blumenkranz_1", duration = 62},
    { name = "cyua_blumenkranz_2", duration = 41},
    { name = "cyua_blumenkranz_3", duration = 72},
    { name = "drifters_opening_1", duration = 42},
    { name = "drifters_opening_2", duration = 45},
    { name = "eir_aoi_sirius_1", duration = 28},
    { name = "eir_aoi_sirius_2", duration = 48},
    { name = "exdream_arena_1", duration = 61},
    { name = "exdream_arena_wars_2", duration = 55},
    { name = "exdream_arena_wars_3", duration = 56},
    { name = "exdream_arena_wars_4", duration = 40},
    { name = "exdream_arena_wars_5", duration = 42},
    { name = "flow_colors_1", duration = 32},
    { name = "flow_colors_2", duration = 58},
    { name = "full_heavenly_delusion_1", duration = 43},
    { name = "full_heavenly_delusion_2", duration = 30},
    { name = "full_heavenly_delusion_3", duration = 59},
    { name = "full_heavenly_delusion_4", duration = 62},
    { name = "i_wish_kaminaki_sekai_1", duration = 47},
    { name = "i_wish_kaminaki_sekai_2", duration = 54},
    { name = "i_wish_kaminaki_sekai_3", duration = 53},
    { name = "igor_rastearyaev_lentochka_1", duration = 66},
    { name = "igor_rastearyaev_lentochka_2", duration = 98},
    { name = "igor_rastearyaev_lentochka_3", duration = 83},
    { name = "imagine_dragons_arcane_1", duration = 63},
    { name = "imagine_dragons_arcane_2", duration = 50},
    { name = "imagine_dragons_arcane_3", duration = 48},
    { name = "imagine_dragons_warriors_1", duration = 41},
    { name = "imagine_dragons_warriors_2", duration = 48},
    { name = "imagine_dragons_warriors_3", duration = 56},
    { name = "inconnu_death_parade_1", duration = 56},
    { name = "inconnu_death_parade_2", duration = 58},
    { name = "inconnu_death_parade_3", duration = 55},
    { name = "joshua_kyan_aalampour_nocturne", duration = 23},
    { name = "kda_madison_beer_1", duration = 37},
    { name = "kda_madison_beer_2", duration = 60},
    { name = "kda_madison_beer_3", duration = 44},
    { name = "kda_madison_beer_4", duration = 34},
    { name = "know_name_welcome_1", duration = 56},
    { name = "know_name_welcome_2", duration = 61},
    { name = "know_name_welcome_3", duration = 60},
    { name = "koi_no_disco_queen_1", duration = 43},
    { name = "koi_no_disco_queen_2", duration = 60},
    { name = "koi_no_disco_queen_3", duration = 75},
    { name = "lirnik_band_detstvo_1", duration = 82},
    { name = "lirnik_band_detstvo_2", duration = 48},
    { name = "lirnik_band_detstvo_3", duration = 49},
    { name = "lirnik_band_jiguli_1", duration = 96},
    { name = "lirnik_band_jiguli_2", duration = 76},
    { name = "lirnik_band_jiguli_3", duration = 76},
    { name = "lirnik_band_znamenka_1", duration = 73},
    { name = "lirnik_band_znamenka_2", duration = 58},
    { name = "lirnik_band_znamenka_3", duration = 60},
    { name = "lirnik_band_znamenka_4", duration = 68},
    { name = "mirai_nikki_yousei_teikoku_1", duration = 44},
    { name = "mirai_nikki_yousei_teikoku_2", duration = 43},
    { name = "mirazh_nastupaet_noch_1", duration = 81},
    { name = "mirazh_nastupaet_noch_2", duration = 70},
    { name = "mirazh_nastupaet_noch_3", duration = 73},
    { name = "nana_mizuki_cross_ange_1", duration = 78},
    { name = "nana_mizuki_cross_ange_2", duration = 48},
    { name = "nana_mizuki_cross_ange_3", duration = 53},
    { name = "nana_mizuki_cross_ange_4", duration = 47},
    { name = "nathan_evans_wellerman_1", duration = 50},
    { name = "nathan_evans_wellerman_2", duration = 49},
    { name = "nathan_evans_wellerman_3", duration = 30},
    { name = "nathan_evans_wellerman_4", duration = 22},
    { name = "noragami_op_1_1", duration = 60},
    { name = "noragami_op_1_2", duration = 54},
    { name = "noragami_op_2_1", duration = 51},
    { name = "noragami_op_2_2", duration = 41},
    { name = "noragami_op_2_3", duration = 46},
    { name = "one_piece_op_11_1", duration = 53},
    { name = "one_piece_op_11_2", duration = 46},
    { name = "one_piece_op_11_3", duration = 50},
    { name = "one_piece_we_are_1", duration = 56},
    { name = "one_piece_we_are_2", duration = 40},
    { name = "one_piece_we_are_3", duration = 40},
    { name = "one_piece_we_are_4", duration = 57},
    { name = "overlord_hollow_hunger_1", duration = 77},
    { name = "overlord_hollow_hunger_2", duration = 51},
    { name = "overlord_hollow_hunger_3", duration = 39},
    { name = "overlord_op_1", duration = 51},
    { name = "overlord_op_2", duration = 38},
    { name = "overlord_op_3", duration = 39},
    { name = "overlord_op_4", duration = 51},
    { name = "paul_romero_necromancer_town_hom2_1", duration = 60},
    { name = "paul_romero_necromancer_town_hom2_2", duration = 51},
    { name = "planya_channe_knopochka_1", duration = 35},
    { name = "planya_channe_knopochka_2", duration = 60},
    { name = "planya_channe_knopochka_3", duration = 33},
    { name = "planya_channe_knopochka_4", duration = 52},
    { name = "re_zero_op1_1", duration = 36},
    { name = "re_zero_op1_2", duration = 48},
    { name = "re_zero_op2_1", duration = 42},
    { name = "re_zero_op2_2", duration = 47},
    { name = "sailor_moon_moonlight_1", duration = 38},
    { name = "sailor_moon_moonlight_2", duration = 43},
    { name = "sao_lisa_crossing_field_1", duration = 32},
    { name = "sao_lisa_crossing_field_2", duration = 34},
    { name = "sao_lisa_crossing_field_3", duration = 39},
    { name = "sao_lisa_crossing_field_4", duration = 45},
    { name = "serega_pirat_apelsin_1", duration = 21},
    { name = "serega_pirat_apelsin_2", duration = 43},
    { name = "serega_pirat_fp_am_1", duration = 51},
    { name = "serega_pirat_fp_am_2", duration = 35},
    { name = "serega_pirat_fp_am_3", duration = 45},
    { name = "serega_pirat_moy_baik_1", duration = 36},
    { name = "serega_pirat_moy_baik_2", duration = 43},
    { name = "serega_pirat_moy_baik_3", duration = 42},
    { name = "serega_pirat_moy_baik_4", duration = 50},
    { name = "serega_pirat_moy_slark_1", duration = 58},
    { name = "serega_pirat_moy_slark_2", duration = 54},
    { name = "serega_pirat_tp_am_1", duration = 42},
    { name = "serega_pirat_tp_am_2", duration = 42},
    { name = "serega_pirat_tp_am_3", duration = 41},
    { name = "shaman_king_opening", duration = 57},
    { name = "shaman_king_ost", duration = 57},
    { name = "shyne_bad_boyz", duration = 43},
    { name = "sid_rainbu_no_melody_1", duration = 22},
    { name = "sid_rainbu_no_melody_2", duration = 23},
    { name = "stein_gate_0_op_1", duration = 73},
    { name = "stein_gate_0_op_2", duration = 75},
    { name = "stein_gate_op_1", duration = 79},
    { name = "stein_gate_op_2", duration = 31},
    { name = "stein_gate_op_3", duration = 61},
    { name = "stereo_dive_renegade_1", duration = 50},
    { name = "stereo_dive_renegade_2", duration = 30},
    { name = "suzume_radwimps_1", duration = 52},
    { name = "suzume_radwimps_2", duration = 30},
    { name = "suzume_radwimps_3", duration = 55},
    { name = "suzume_radwimps_4", duration = 37},
    { name = "takayan_toy_1", duration = 57},
    { name = "takayan_toy_2", duration = 57},
    { name = "takayan_toy_3", duration = 52},
    { name = "takayan_whats_meaning_1", duration = 48},
    { name = "takayan_whats_meaning_2", duration = 54},
    { name = "tany_degurechaff_los_los_1", duration = 65},
    { name = "tany_degurechaff_los_los_2", duration = 54},
    { name = "tengen_toppa_row_row", duration = 77},
    { name = "the_glitch_mob_mako_1", duration = 81},
    { name = "the_glitch_mob_mako_2", duration = 55},
    { name = "tochka_zapyataya_1", duration = 65},
    { name = "tochka_zapyataya_2", duration = 36},
    { name = "tokyo_ghoul_op1_1", duration = 45},
    { name = "tokyo_ghoul_op1_2", duration = 41},
    { name = "toradora_op_1", duration = 35},
    { name = "toradora_op_2", duration = 51},
    { name = "twinky_ghoul_1", duration = 66},
    { name = "twinky_ghoul_2", duration = 46},
    { name = "twinky_rampajka_1", duration = 76},
    { name = "twinky_rampajka_2", duration = 55},
    { name = "twinky_tima_ya_slila_mid_1", duration = 68},
    { name = "twinky_tima_ya_slila_mid_2", duration = 66},
    { name = "visotsky_alice_mnogo_neysnogo", duration = 63},
    { name = "visotsky_alice_pesnya_popugaya_1", duration = 61},
    { name = "visotsky_alice_pesnya_popugaya_2", duration = 51},
    { name = "visotsky_alice_pesnya_popugaya_3", duration = 36},
    { name = "voracity_by_myth_1", duration = 50},
    { name = "voracity_by_myth_2", duration = 30},
    { name = "voracity_by_myth_3", duration = 57},
    { name = "yoasobi_idol_oshi_1", duration = 48},
    { name = "yoasobi_idol_oshi_2", duration = 85},
    { name = "yoasobi_idol_oshi_3", duration = 78},
    { name = "yoko_takahashi_a_cruel_angel_1", duration = 63},
    { name = "yoko_takahashi_a_cruel_angel_2", duration = 52},
    { name = "yoko_takahashi_a_cruel_angel_3", duration = 37},
    { name = "yoko_takahashi_a_cruel_angel_4", duration = 52},
    { name = "ytpmv_killer_beast_1", duration = 40},
    { name = "ytpmv_killer_beast_2", duration = 66},
    { name = "ziyoou_kaen_dororo", duration = 79},
}

local WD_THINK = 0.25

local hPlayers = {}

function Spawn( entityKeyValues )
	if not IsServer() then
		return
	end

	if thisEntity == nil then
		return
	end
	
    CustomGameEventManager:RegisterListener( "set_sound_state_wd", function( _, data )
        hPlayers[tonumber(data.PlayerID)] = hPlayers[tonumber(data.PlayerID)] or {}
		hPlayers[tonumber(data.PlayerID)].state = data.state == 1
        hPlayers[tonumber(data.PlayerID)].pid = data.PlayerID

        CustomNetTables:SetTableValue("unit_upgrades", "wd_sounds", hPlayers)
	end)

    thisEntity.RollSound = function()
        if(#music_list == 0) then
            return
        end
        if(not thisEntity or thisEntity:IsNull() == true) then
            return
        end
        local soundIndex = RandomInt(1, #music_list)
        local randomMusic = music_list[soundIndex]
        if (not randomMusic or not randomMusic.name) then
            thisEntity.RollSound()
            return
        end 
        thisEntity:RemoveModifierByName("modifier_witch_doctor_music")
        thisEntity:AddNewModifier(thisEntity, nil, "modifier_witch_doctor_music", {duration = randomMusic.duration, music_index = soundIndex})
    end
    thisEntity:SetContextThink("WD_DODIK_Think", function()
        if(GameRules:State_Get() > DOTA_GAMERULES_STATE_PRE_GAME) then
            thisEntity.RollSound()
            return -1
        end
        return 1
    end, 1)
end

modifier_witch_doctor_music = class({
	IsHidden 				= function(self) return true end,
	IsPurgable 				= function(self) return false end,
	IsDebuff 				= function(self) return false end,
	IsBuff                  = function(self) return true end,
	RemoveOnDeath 			= function(self) return true end,
    RegisterFunctions = function()
        return {
            MODIFIER_PROPERTY_OVERRIDE_ANIMATION
        }
    end,
    GetOverrideAnimation = function()
        return ACT_DOTA_VICTORY
    end
})

function modifier_witch_doctor_music:OnCreated(params)
    self.parent = self:GetParent()
    if IsServer() then
        self:SetStackCount(params.music_index)
        self.music = self:GetCurrentMusicName()
        self.parent:StartGesture(self:GetOverrideAnimation())
        for id=0, PlayerResource:GetNumConnectedHumanPlayers() do
            if(self:IsPlayerDisabledMusic(id) == false and PlayerResource:IsValidPlayer(id) == true) then
                EmitSoundOnEntityForPlayer(self.music, self.parent, id)
            end
        end
    else
        self:StartIntervalThink(WD_THINK)
    end
end

function modifier_witch_doctor_music:GetCurrentMusicName()
    return music_list[self:GetStackCount()].name
end

function modifier_witch_doctor_music:IsPlayerDisabledMusic(playerID)
    local play = false
    local data = CustomNetTables:GetTableValue("unit_upgrades", "wd_sounds")
    local id = tostring(playerID)
    if data and data[id] and data[id].state == 0 then
        play = true
    end
    return play
end

function modifier_witch_doctor_music:OnIntervalThink()
    if IsClient() then
        if(not self.music) then
            self.music = self:GetCurrentMusicName()
        end
        if(self.music) then
            local sound_pfx =ParticleManager:CreateParticle("particles/econ/events/ti9/ti9_drums_musicnotes.vpcf", PATTACH_OVERHEAD_FOLLOW, self.parent)
            ParticleManager:SetParticleControlEnt(sound_pfx, 0, self.parent, PATTACH_POINT_FOLLOW, "attach_hitloc", Vector(0, 0, 50), true)
            ParticleManager:ReleaseParticleIndex(sound_pfx)

            if (self:IsPlayerDisabledMusic(GetLocalPlayerID()) == true) then
                StopSoundEvent(self.music, self.parent)
                StopSoundOn(self.music, self.parent)
                self:StartIntervalThink(-1)
            end
        end
    end
end

function modifier_witch_doctor_music:OnDestroy()
	StopSoundEvent(self.music, self.parent)
    if(IsServer()) then
        self.parent.RollSound()
    end
end


LinkLuaModifier("modifier_witch_doctor_music", "ai/special/ai_wd_dodik", LUA_MODIFIER_MOTION_NONE, modifier_witch_doctor_music)
