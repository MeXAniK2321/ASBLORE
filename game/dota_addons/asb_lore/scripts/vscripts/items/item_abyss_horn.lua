item_abyss_horn = item_abyss_horn or class({})
LinkLuaModifier("modifier_item_abyss_horn", "items/item_abyss_horn", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("modifier_hero_route", "items/item_abyss_horn", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("modifier_demon_route", "items/item_abyss_horn", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("modifier_samurai_route", "items/item_abyss_horn", LUA_MODIFIER_MOTION_NONE)
--===================================================================================================--
LinkLuaModifier("modifier_abyss_choice", "items/item_abyss_horn", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("modifier_abyss_chosed", "items/item_abyss_horn", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("modifier_abyss_horn_cd", "items/item_abyss_horn", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("modifier_abyss_start", "items/item_abyss_horn", LUA_MODIFIER_MOTION_NONE)
--===================================================================================================--
LinkLuaModifier("modifier_hero_route_1", "items/item_abyss_horn", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("modifier_hero_route_2", "items/item_abyss_horn", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("modifier_hero_route_3", "items/item_abyss_horn", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("modifier_hero_route_4", "items/item_abyss_horn", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("modifier_hero_route_5", "items/item_abyss_horn", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("modifier_hero_route_6", "items/item_abyss_horn", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("modifier_hero_route_true", "items/item_abyss_horn", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("modifier_hero_route_alt", "items/item_abyss_horn", LUA_MODIFIER_MOTION_NONE)
--===================================================================================================--
LinkLuaModifier("modifier_demon_route_1", "items/item_abyss_horn", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("modifier_demon_route_2", "items/item_abyss_horn", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("modifier_demon_route_3", "items/item_abyss_horn", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("modifier_demon_route_4", "items/item_abyss_horn", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("modifier_demon_route_5", "items/item_abyss_horn", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("modifier_demon_route_6", "items/item_abyss_horn", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("modifier_demon_route_true", "items/item_abyss_horn", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("modifier_demon_route_control", "items/item_abyss_horn", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("modifier_demon_route_slow", "items/item_abyss_horn", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("modifier_demon_route_alt", "items/item_abyss_horn", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("modifier_succubus_orgy", "items/item_angel_halo", LUA_MODIFIER_MOTION_NONE)
--===================================================================================================--
LinkLuaModifier("modifier_samurai_route_1", "items/item_abyss_horn", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("modifier_samurai_route_2", "items/item_abyss_horn", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("modifier_samurai_route_3", "items/item_abyss_horn", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("modifier_samurai_route_4", "items/item_abyss_horn", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("modifier_samurai_route_5", "items/item_abyss_horn", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("modifier_samurai_route_6", "items/item_abyss_horn", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("modifier_samurai_route_true", "items/item_abyss_horn", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("modifier_samurai_route_alt", "items/item_abyss_horn", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("modifier_samurai_bleed", "items/item_abyss_horn", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("modifier_samurai_block", "items/item_abyss_horn", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("modifier_samurai_block2", "items/item_abyss_horn", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("modifier_samurai_full_counter", "items/item_abyss_horn", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("modifier_samurai_slow", "items/item_abyss_horn", LUA_MODIFIER_MOTION_NONE)
--===================================================================================================--
LinkLuaModifier("modifier_halo_slow", "items/item_angel_halo", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("modifier_halo_attack", "items/item_angel_halo", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("modifier_halo_root", "items/item_angel_halo", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("modifier_lust_armor_invul", "items/item_angel_halo", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("modifier_angel_halo_stage_10_invul", "items/item_angel_halo", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("modifier_halo_spirits_stats_1", "items/item_abyss_horn", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("modifier_halo_spirits_stats_2", "items/item_abyss_horn", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("modifier_halo_spirits_stats_3", "items/item_abyss_horn", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("modifier_halo_spirits_stats_4", "items/item_abyss_horn", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("modifier_halo_fire", "items/item_abyss_horn", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("modifier_halo_earth", "items/item_abyss_horn", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("modifier_halo_water", "items/item_abyss_horn", LUA_MODIFIER_MOTION_NONE)
LinkLuaModifier("modifier_halo_wind", "items/item_abyss_horn", LUA_MODIFIER_MOTION_NONE)

function item_abyss_horn:GetIntrinsicModifierName()
	return "modifier_item_abyss_horn"
end
function item_abyss_horn:GetBehavior()
    return self:GetCaster():HasModifier("modifier_abyss_start") 
	       and DOTA_ABILITY_BEHAVIOR_UNIT_TARGET
		   or DOTA_ABILITY_BEHAVIOR_NO_TARGET
end
function item_abyss_horn:OnSpellStart()
	if not IsServer() then return end
	
	local caster = self:GetCaster()
	local duration = 60
	local target = self:GetCursorTarget()
	local PID = caster:GetPlayerOwnerID()
    local id32 = PlayerResource:IsFakeClient(PID) and PID * 32 or PlayerResource:GetSteamAccountID(PID)
	local hero = PlayerResource:GetSelectedHeroEntity(PID)
	
    local hTablePerfAttack  = {}
    
    -- Fill in the hTablePerfAttack table with all the optional arguments
    hTablePerfAttack[1] = target -- Target
    hTablePerfAttack[2] = true -- bUseCastAttackOrb
    hTablePerfAttack[3] = true  -- bProcessProcs
    hTablePerfAttack[4] = true -- bSkipCooldown
    hTablePerfAttack[5] = false -- bIgnoreInvis
    hTablePerfAttack[6] = false -- bUseProjectile
    hTablePerfAttack[7] = false -- bFakeAttack
    hTablePerfAttack[8] = true -- bNeverMiss
    
	local damageTable = {
		                attacker = caster,
		                damage = damage,
		                damage_type = DAMAGE_TYPE_PHYSICAL,
		                ability = self,
		                damage_flags = DOTA_DAMAGE_FLAG_NO_SPELL_AMPLIFICATION,
		                victim = target,
	                    }					 
	
    if caster:HasModifier("modifier_abyss_start") then
----------------------------------------------------------------------------------------------
-- HERO ROUTE
----------------------------------------------------------------------------------------------
	  if caster:HasModifier("modifier_hero_route_1") then
        self:GetCaster():PerformAttack (unpack(hTablePerfAttack))
	    EmitSoundOn("halo.attack", caster)
	    self:PlayEffects(target, "particles/econ/items/wraith_king/wraith_king_arcana/wk_arc_weapon_blur_critical.vpcf")

	  elseif caster:HasModifier("modifier_hero_route_2") then
        self:GetCaster():PerformAttack (unpack(hTablePerfAttack))
	    target:AddNewModifier(caster, self, "modifier_halo_slow", {duration = 2})
	    EmitSoundOn("halo.water", caster)
	    self:PlayEffects(target, "particles/econ/items/monkey_king/arcana/water/monkey_king_spring_water_base.vpcf")
      
	  elseif caster:HasModifier("modifier_hero_route_3") then
        local modifier = self:GetCaster():AddNewModifier(self:GetCaster(), self, "modifier_halo_attack", {})
	    self:GetCaster():PerformAttack (unpack(hTablePerfAttack))
	    modifier:Destroy()
	    EmitSoundOn("halo.crit", caster)
	    self:PlayEffects(target, "particles/halo_crit.vpcf")
     
	 elseif caster:HasModifier("modifier_hero_route_4") then
       local hp = caster:GetHealth()
       local max_hp = caster:GetMaxHealth()
       local damage = 400 + (max_hp - hp) * 0.4
       
	   EmitSoundOn("halo.crit", caster)
	   
	   damageTable.damage = damage
	   ApplyDamage(damageTable)
       self:PlayEffects(target, "particles/sf_fire_arcana_shadowraze_collumn1.vpcf")
     
	 elseif caster:HasModifier("modifier_hero_route_5") then
	   local delay = 1
	   
	   EmitSoundOn("halo.magic", caster)
	   EmitSoundOn("halo.magic_exp", caster)
	   target:AddNewModifier(caster, self, "modifier_stunned", {duration = 1.0})
	   Timers:CreateTimer(delay,function()
		damageTable.damage = 1000
		damageTable.damage_type = DAMAGE_TYPE_PURE
		ApplyDamage(damageTable)
	   end)
		self:PlayEffects(target, "particles/halo_7_explosion.vpcf")
     
	 elseif caster:HasModifier("modifier_hero_route_6") then
       local hp = caster:GetHealth()
       local max_hp = caster:GetMaxHealth()
       local damage = (max_hp - hp)
       
	   EmitSoundOn("halo.crit", caster)
	   
	   damageTable.damage = damage
	   ApplyDamage(damageTable)
	   self:PlayEffects(target, "particles/holy_light.vpcf")

----------------------------------------------------------------------------------------------
-- DEMON ROUTE
----------------------------------------------------------------------------------------------
	 elseif caster:HasModifier("modifier_demon_route_1") then
       target:AddNewModifier(caster, self, "modifier_halo_slow", {duration = 2})
	   EmitSoundOn("halo.dark_1", caster)
	   
	   damageTable.damage = 400
	   damageTable.damage_type = DAMAGE_TYPE_PURE
	   ApplyDamage(damageTable)
	   self:PlayEffects(target, "particles/econ/items/nightstalker/nightstalker_black_nihility/nightstalker_black_nihility_void_hit.vpcf")
	 
	 elseif caster:HasModifier("modifier_demon_route_2") then
       target:AddNewModifier(caster, self, "modifier_halo_root", {duration = 1})
	   EmitSoundOn("halo.dark_1", caster)

       damageTable.damage = 500
       damageTable.damage_type = DAMAGE_TYPE_PURE
	   ApplyDamage(damageTable)
	   self:PlayEffects(target, "particles/halo_dark.vpcf")
		
	 elseif caster:HasModifier("modifier_demon_route_3") then
	   EmitSoundOn("halo.dark_2", caster)
	   
	   damageTable.damage = 600
       damageTable.damage_type = DAMAGE_TYPE_PURE
       ApplyDamage(damageTable)
       self:PlayEffects(target, "particles/halo_lust_armor_active_sealed.vpcf")
       caster:Heal(100,caster)
		
     elseif caster:HasModifier("modifier_demon_route_4") then
       target:AddNewModifier(caster, self, "modifier_halo_root", {duration = 1})
	   EmitSoundOn("halo.dark_2", caster)

       damageTable.damage = 700
	   damageTable.damage_type = DAMAGE_TYPE_PURE
	   ApplyDamage(damageTable)
	   self:PlayEffects(target, "particles/halo_lust_armor_active_awaken.vpcf")
	   caster:Heal(100,caster)

     elseif caster:HasModifier("modifier_demon_route_6") then
	   if target:GetUnitName()== "npc_dota_hero_axe" or  target:GetUnitName()== "npc_dota_hero_beastmaster" then
	     EmitSoundOn("halo.succubus_gachi", caster)
	     EmitSoundOn("halo.succubus_gachi_2", caster)
	   else
	     EmitSoundOn("halo.succubus", caster)
	     EmitSoundOn("halo.succubus2", caster)
	   end
	   target:AddNewModifier(caster, self, "modifier_succubus_orgy", {duration = 4.5})

     elseif caster:HasModifier("modifier_demon_route_5") then
	   local sound_cast2 = "halo.slash"
	   EmitSoundOn( sound_cast2, target )
	   local arcana = 137775440
	   
	   if id32 == arcana then
	     self:PlayEffects( target, "particles/halo_stage_10_true_crit.vpcf")
	   else
	     self:PlayEffects( target, "particles/halo_10_portal.vpcf")
	   end
	
	   target:AddNewModifier(caster, self, "modifier_stunned", {duration = 0.5})
	   damageTable.damage = 800
	   damageTable.damage_type = DAMAGE_TYPE_PURE
	   ApplyDamage(damageTable)
			
----------------------------------------------------------------------------------------------
-- SAMURAI ROUTE
----------------------------------------------------------------------------------------------
	 elseif caster:HasModifier("modifier_samurai_route_1") then
	   caster:AddNewModifier(caster, self, "modifier_samurai_block", {duration = 5})
	   EmitSoundOn("halo.crit", caster)
	    
	   damageTable.damage = 400
	   damageTable.damage_type = DAMAGE_TYPE_PURE
	   ApplyDamage(damageTable)
	   self:PlayEffects(target, "particles/samurai_slash_0.vpcf")
		
	 elseif caster:HasModifier("modifier_samurai_route_2") then
	   caster:AddNewModifier(caster, self, "modifier_samurai_block", {duration = 5})
	   EmitSoundOn("halo.crit", caster)
	   
	   damageTable.damage = 600
	   damageTable.damage_type = DAMAGE_TYPE_PURE
	   ApplyDamage(damageTable)
       self:PlayEffects(target, "particles/samura_slash1.vpcf")
		
     elseif caster:HasModifier("modifier_samurai_route_3") then
	   caster:AddNewModifier(caster, self, "modifier_samurai_block2", {duration = 5})
	   EmitSoundOn("halo.crit", caster)
	   
	   damageTable.damage = 800
	   damageTable.damage_type = DAMAGE_TYPE_PURE
	   ApplyDamage(damageTable)
	   self:PlayEffects(target, "particles/samura_slash2.vpcf")
		
	 elseif caster:HasModifier("modifier_samurai_route_4") then
	   caster:AddNewModifier(caster, self, "modifier_samurai_block2", {duration = 5})
	   EmitSoundOn("halo.crit", caster)
		
	   damageTable.damage = 1000
	   damageTable.damage_type = DAMAGE_TYPE_PURE
	   ApplyDamage(damageTable)
	   self:PlayEffects(target, "particles/samura_slash3.vpcf")
		
	 elseif caster:HasModifier("modifier_samurai_route_5") then
	   caster:AddNewModifier(caster, self, "modifier_samurai_full_counter", {duration = 4})
	   EmitSoundOn("horn.samurai_special", caster)
	   
	   damageTable.damage = 1300
	   damageTable.damage_type = DAMAGE_TYPE_PURE
       ApplyDamage(damageTable)
	   self:PlayEffects(target, "particles/samura_slash4.vpcf")
		
	 elseif caster:HasModifier("modifier_samurai_route_6") then
       target:AddNewModifier(caster, self, "modifier_samurai_bleed", {duration = 4})
	   EmitSoundOn("horn.samurai_special", caster)
		
       damageTable.damage = 1300
       damageTable.damage_type = DAMAGE_TYPE_PURE
	   ApplyDamage(damageTable)
	   self:PlayEffects(target, "particles/samura_slash5.vpcf")
	  end	
    end

    if caster:HasModifier("modifier_abyss_chosed") and not caster:HasModifier("modifier_abyss_start") then
      local modifier_counter = caster:FindModifierByNameAndCaster("modifier_abyss_chosed",caster)
	  self.current_counter = modifier_counter:GetStackCount()
      
	  if caster:HasModifier("modifier_hero_route") then
        if  self.current_counter < 200 then
          caster:AddNewModifier(caster, self, "modifier_abyss_start", {duration = 30})
	      caster:AddNewModifier(caster, self, "modifier_hero_route_1", {duration = 30})
	      self:EndCooldown()
	    elseif self.current_counter < 400 and self.current_counter > 200 or self.current_counter == 200 then
          caster:AddNewModifier(caster, self, "modifier_abyss_start", {duration = 40})
          caster:AddNewModifier(caster, self, "modifier_hero_route_2", {duration = 40})
          self:EndCooldown()
	    elseif self.current_counter < 600 and self.current_counter > 400 or self.current_counter == 400 then
          caster:AddNewModifier(caster, self, "modifier_abyss_start", {duration = 45})
          caster:AddNewModifier(caster, self, "modifier_hero_route_3", {duration = 45})
          self:EndCooldown()
	    elseif self.current_counter < 800 and self.current_counter > 600 or self.current_counter == 600 then
          caster:AddNewModifier(caster, self, "modifier_abyss_start", {duration = 50})
          caster:AddNewModifier(caster, self, "modifier_hero_route_4", {duration = 50})
          self:EndCooldown()
	    elseif self.current_counter >= 800  then
	      if caster:HasModifier("modifier_hero_route_true") then
		    caster:AddNewModifier(caster, self, "modifier_abyss_start", {duration = 50})
	        caster:AddNewModifier(caster, self, "modifier_hero_route_5", {duration = 50})
	        self:EndCooldown()
	      else
	        caster:AddNewModifier(caster, self, "modifier_abyss_start", {duration = 50})
	        caster:AddNewModifier(caster, self, "modifier_hero_route_6", {duration = 50})
	        self:EndCooldown()
	      end
        end
	
	
	  elseif caster:HasModifier("modifier_demon_route") then
        if caster:HasModifier("modifier_abyss_start") then
        else
          if  self.current_counter < 200 then
            caster:AddNewModifier(caster, self, "modifier_abyss_start", {duration = 30})
            caster:AddNewModifier(caster, self, "modifier_demon_route_1", {duration = 30})
            self:EndCooldown()
	      elseif self.current_counter < 400 and self.current_counter > 200 or self.current_counter == 200 then
            caster:AddNewModifier(caster, self, "modifier_abyss_start", {duration = 40})
            caster:AddNewModifier(caster, self, "modifier_demon_route_2", {duration = 40})
            self:EndCooldown()
	      elseif self.current_counter < 600 and self.current_counter > 400 or self.current_counter == 400 then
            caster:AddNewModifier(caster, self, "modifier_abyss_start", {duration = 45})
            caster:AddNewModifier(caster, self, "modifier_demon_route_3", {duration = 45})
            self:EndCooldown()
	      elseif self.current_counter < 800 and self.current_counter > 600 or self.current_counter == 600 then
            caster:AddNewModifier(caster, self, "modifier_abyss_start", {duration = 50})
            caster:AddNewModifier(caster, self, "modifier_demon_route_4", {duration = 50})
            self:EndCooldown()
	      elseif self.current_counter >= 800  then
	        if caster:HasModifier("modifier_demon_route_true") then
		      caster:AddNewModifier(caster, self, "modifier_abyss_start", {duration = 50})
		      caster:AddNewModifier(caster, self, "modifier_demon_route_5", {duration = 50})
		      caster:AddNewModifier(caster, self, "modifier_angel_halo_stage_10_invul", {duration = 3})
		      self:EndCooldown()
		    else
		      caster:AddNewModifier(caster, self, "modifier_abyss_start", {duration = 50})
		      caster:AddNewModifier(caster, self, "modifier_demon_route_6", {duration = 50})
		      caster:AddNewModifier(caster, self, "modifier_lust_armor_invul", {duration = 3})
		      self:EndCooldown()
	        end
          end
        end
	
	  elseif caster:HasModifier("modifier_samurai_route") then
        if caster:HasModifier("modifier_abyss_start") then
        else
          if self.current_counter < 200 then
            caster:AddNewModifier(caster, self, "modifier_abyss_start", {duration = 30})
            caster:AddNewModifier(caster, self, "modifier_samurai_route_1", {duration = 30})
            self:EndCooldown()
	      elseif self.current_counter < 400 and self.current_counter > 200 or self.current_counter == 200 then
            caster:AddNewModifier(caster, self, "modifier_abyss_start", {duration = 40})
            caster:AddNewModifier(caster, self, "modifier_samurai_route_2", {duration = 40})
            self:EndCooldown()
	      elseif self.current_counter < 600 and self.current_counter > 400 or self.current_counter == 400 then
            caster:AddNewModifier(caster, self, "modifier_abyss_start", {duration = 45})
            caster:AddNewModifier(caster, self, "modifier_samurai_route_3", {duration = 45})
            self:EndCooldown()
	      elseif self.current_counter < 800 and self.current_counter > 600 or self.current_counter == 600 then
            caster:AddNewModifier(caster, self, "modifier_abyss_start", {duration = 50})
            caster:AddNewModifier(caster, self, "modifier_samurai_route_4", {duration = 50})
            self:EndCooldown()
	      elseif self.current_counter >= 800  then
	        if caster:HasModifier("modifier_samurai_route_true") then
		      caster:AddNewModifier(caster, self, "modifier_abyss_start", {duration = 60})
		      caster:AddNewModifier(caster, self, "modifier_samurai_route_5", {duration = 60})
		      self:EndCooldown()
		    else
		      caster:AddNewModifier(caster, self, "modifier_abyss_start", {duration = 60})
		      caster:AddNewModifier(caster, self, "modifier_samurai_route_6", {duration = 60})
		      self:EndCooldown()
	        end
          end
        end
	  end
    end
	
    if not caster:HasModifier("modifier_abyss_chosed") and not caster:HasModifier("modifier_abyss_choice")  then
      caster:AddNewModifier(caster, self, "modifier_abyss_choice", {duration = 5})
      self:EndCooldown()
      EmitSoundOn("horn.choose_destiny", caster)
    end
    
	if caster:HasModifier("modifier_abyss_choice") then
      self:EndCooldown()
      local modifier = caster:FindModifierByNameAndCaster("modifier_abyss_choice",caster)
	  if modifier == nil then return end
	    local current = modifier:GetStackCount()
	    if current == 3 then
	      modifier:SetStackCount(1)
	    else
	      modifier:SetStackCount(current + 1)
	    end
	end
end
	
function item_abyss_horn:PlayEffects( target, sParticleName )
	-- Load effects
	local particle_cast = sParticleName

	local effect_cast = ParticleManager:CreateParticle( particle_cast, PATTACH_ABSORIGIN_FOLLOW, target )
	ParticleManager:SetParticleControlEnt(
		effect_cast,
		0,
		target,
		PATTACH_POINT_FOLLOW,
		"attach_hitloc",
		target:GetOrigin(), -- unknown
		true -- unknown, true
	)
	ParticleManager:SetParticleControlForward( effect_cast, 1, (self:GetParent():GetOrigin()-target:GetOrigin()):Normalized() )
	ParticleManager:ReleaseParticleIndex( effect_cast )
end

function item_abyss_horn:PlayEffects6( target )
	-- Load effects
	local particle_cast = "particles/kuroalice_necro_strike.vpcf"
	
	local effect_cast = ParticleManager:CreateParticle( particle_cast, PATTACH_ABSORIGIN_FOLLOW, target )
	ParticleManager:SetParticleControlEnt(
		effect_cast,
		0,
		target,
		PATTACH_POINT_FOLLOW,
		"attach_hitloc",
		target:GetOrigin(), -- unknown
		true -- unknown, true
	)
	ParticleManager:SetParticleControlForward( effect_cast, 1, (self:GetParent():GetOrigin()-target:GetOrigin()):Normalized() )
	ParticleManager:ReleaseParticleIndex( effect_cast )
end
function item_abyss_horn:PlayEffects7( target )
	-- Load effects
	local particle_cast = "particles/kuroalice_necro_strike_lvl2.vpcf"
	
	local effect_cast = ParticleManager:CreateParticle( particle_cast, PATTACH_ABSORIGIN_FOLLOW, target )
	ParticleManager:SetParticleControlEnt(
		effect_cast,
		0,
		target,
		PATTACH_POINT_FOLLOW,
		"attach_hitloc",
		target:GetOrigin(), -- unknown
		true -- unknown, true
	)
	ParticleManager:SetParticleControlForward( effect_cast, 1, (self:GetParent():GetOrigin()-target:GetOrigin()):Normalized() )
	ParticleManager:ReleaseParticleIndex( effect_cast )
end

modifier_abyss_choice = modifier_abyss_choice or class({})

function modifier_abyss_choice:IsHidden() return false end
function modifier_abyss_choice:IsDebuff() return false end
function modifier_abyss_choice:IsPurgable() return false end
function modifier_abyss_choice:IsPurgeException() return false end
function modifier_abyss_choice:RemoveOnDeath() return false end
function modifier_abyss_choice:DeclareFunctions()
	local func = {	
				     MODIFIER_PROPERTY_TRANSLATE_ACTIVITY_MODIFIERS,
				 }
	return func
end
function modifier_abyss_choice:OnCreated( kv )
	if IsServer() then
		self:SetStackCount(1)
	end
end
function modifier_abyss_choice:OnDestroy()
    local stack = self:GetStackCount()
    local caster = self:GetCaster()
	local ability = self:GetAbility()
    if stack == 1 then
      caster:AddNewModifier(caster, ability, "modifier_hero_route", {})
    elseif stack == 2 then
      caster:AddNewModifier(caster, ability, "modifier_demon_route", {})
    else
      caster:AddNewModifier(caster, ability, "modifier_samurai_route", {})
    end
    
	caster:AddNewModifier(caster, ability, "modifier_abyss_chosed", {})
end
function modifier_abyss_choice:OnStackCountChanged(iStackCount)
	if IsServer() then
		self:ForceRefresh()
		self.parent = self:GetParent()

		if self.Charge_FX then
			ParticleManager:DestroyParticle(self.Charge_FX, false)
			ParticleManager:ReleaseParticleIndex(self.Charge_FX)
		end

		local stacks = self:GetStackCount()

		if stacks == 1 then
			self.Charge_FX =   	ParticleManager:CreateParticle("particles/horn_choice.vpcf", PATTACH_OVERHEAD_FOLLOW, self.parent)
								       															
	                            
		elseif stacks == 2 then
	  		self.Charge_FX =   	ParticleManager:CreateParticle("particles/horn_choice2.vpcf", PATTACH_OVERHEAD_FOLLOW, self.parent)
                            	

		else
	  		self.Charge_FX =   	ParticleManager:CreateParticle("particles/horn_choice3.vpcf", PATTACH_OVERHEAD_FOLLOW, self.parent)
                            
							
        end
	end
end

function modifier_abyss_choice:GetAbilityTextureName()
	return "angel_halo"
end


modifier_abyss_chosed = modifier_abyss_chosed or class({})

function modifier_abyss_chosed:IsHidden() return false end
function modifier_abyss_chosed:IsDebuff() return false end
function modifier_abyss_chosed:IsPurgable() return false end
function modifier_abyss_chosed:IsPurgeException() return false end
function modifier_abyss_chosed:RemoveOnDeath() return false end

function modifier_abyss_chosed:OnCreated( kv )
	self.kill = 800
	
	if IsServer() then
		self:SetStackCount(0)
	end
	self:StartIntervalThink(1.0)
end
function modifier_abyss_chosed:OnIntervalThink()
    if not IsServer() then return end
	
	local caster = self:GetParent()
    local stack = self:GetStackCount()
    local target = caster
    local Player = PlayerResource:GetPlayer(caster:GetPlayerID())
	local kills = PlayerResource:GetKills(caster:GetPlayerID())
	local death = PlayerResource:GetDeaths(caster:GetPlayerID())
	local ability = self:GetAbility()
    
	if GameRules:GetGameTime() > 2400 then
      self:AddStack(2)
    else
      self:AddStack(2)
    end
    
	if not caster:HasModifier("modifier_samurai_route_true") and not caster:HasModifier("modifier_samurai_route_alt") and not caster:HasModifier("modifier_demon_route_true") and not caster:HasModifier("modifier_hero_route_true") and not caster:HasModifier("modifier_demon_route_alt") and not caster:HasModifier("modifier_hero_route_alt") then
      if stack >= 800 then
        if caster:HasModifier("modifier_samurai_route")  then
          if kills - death > 11 then
            target:AddNewModifier(caster, ability, "modifier_samurai_route_true", {})
          else
            target:AddNewModifier(caster, ability, "modifier_samurai_route_alt", {})
          end
        elseif caster:HasModifier("modifier_demon_route") then
          if kills > 17 then
            target:AddNewModifier(caster, ability, "modifier_demon_route_true", {})
          else
            target:AddNewModifier(caster, ability, "modifier_demon_route_alt", {})
          end
        elseif caster:HasModifier("modifier_hero_route") then
          if death < 3 then
            target:AddNewModifier(caster, ability, "modifier_hero_route_true", {})
          else
            target:AddNewModifier(caster, ability, "modifier_hero_route_alt", {})
          end
        end
      end
	end
end
function modifier_abyss_chosed:OnRefresh( kv )
	local max_stack = 800

	if IsServer() then
		if self:GetStackCount()<max_stack then
			self:IncrementStackCount()
		end
	end
end
function modifier_abyss_chosed:AddStack( value )
	local current = self:GetStackCount()
	local after = current + value
		if after > self.kill then
			after = self.kill
		end
	self:SetStackCount( after )
end
function modifier_abyss_chosed:GetAbilityTextureName()
	return "angel_halo"
end


modifier_hero_route = modifier_hero_route or class({})

function modifier_hero_route:IsHidden() return false end
function modifier_hero_route:IsDebuff() return false end
function modifier_hero_route:IsPurgable() return false end
function modifier_hero_route:IsPurgeException() return false end
function modifier_hero_route:RemoveOnDeath() return false end


modifier_hero_route_true = modifier_hero_route_true or class({})

function modifier_hero_route_true:IsHidden() return true end
function modifier_hero_route_true:IsDebuff() return false end
function modifier_hero_route_true:IsPurgable() return false end
function modifier_hero_route_true:IsPurgeException() return false end
function modifier_hero_route_true:RemoveOnDeath() return false end


modifier_hero_route_alt = modifier_hero_route_alt or class({})

function modifier_hero_route_alt:IsHidden() return true end
function modifier_hero_route_alt:IsDebuff() return false end
function modifier_hero_route_alt:IsPurgable() return false end
function modifier_hero_route_alt:IsPurgeException() return false end
function modifier_hero_route_alt:RemoveOnDeath() return false end


modifier_demon_route_alt = modifier_demon_route_alt or class({})

function modifier_demon_route_alt:IsHidden() return true end
function modifier_demon_route_alt:IsDebuff() return false end
function modifier_demon_route_alt:IsPurgable() return false end
function modifier_demon_route_alt:IsPurgeException() return false end
function modifier_demon_route_alt:RemoveOnDeath() return false end


modifier_demon_route_true = modifier_demon_route_true or class({})

function modifier_demon_route_true:IsHidden() return true end
function modifier_demon_route_true:IsDebuff() return false end
function modifier_demon_route_true:IsPurgable() return false end
function modifier_demon_route_true:IsPurgeException() return false end
function modifier_demon_route_true:RemoveOnDeath() return false end


modifier_samurai_route_true = modifier_samurai_route_true or class({})

function modifier_samurai_route_true:IsHidden() return true end
function modifier_samurai_route_true:IsDebuff() return false end
function modifier_samurai_route_true:IsPurgable() return false end
function modifier_samurai_route_true:IsPurgeException() return false end
function modifier_samurai_route_true:RemoveOnDeath() return false end


modifier_samurai_route_alt = modifier_samurai_route_alt or class({})

function modifier_samurai_route_alt:IsHidden() return true end
function modifier_samurai_route_alt:IsDebuff() return false end
function modifier_samurai_route_alt:IsPurgable() return false end
function modifier_samurai_route_alt:IsPurgeException() return false end
function modifier_samurai_route_alt:RemoveOnDeath() return false end


modifier_demon_route = modifier_demon_route or class({})

function modifier_demon_route:IsHidden() return false end
function modifier_demon_route:IsDebuff() return false end
function modifier_demon_route:IsPurgable() return false end
function modifier_demon_route:IsPurgeException() return false end
function modifier_demon_route:RemoveOnDeath() return false end


modifier_samurai_route = modifier_samurai_route or class({})

function modifier_samurai_route:IsHidden() return false end
function modifier_samurai_route:IsDebuff() return false end
function modifier_samurai_route:IsPurgable() return false end
function modifier_samurai_route:IsPurgeException() return false end
function modifier_samurai_route:RemoveOnDeath() return false end


modifier_abyss_start = modifier_abyss_start or class({})

function modifier_abyss_start:IsHidden() return false end
function modifier_abyss_start:IsDebuff() return false end
function modifier_abyss_start:IsPurgable() return false end
function modifier_abyss_start:IsPurgeException() return false end
function modifier_abyss_start:RemoveOnDeath() return true end
---------------------------------------------------------------------------------------------------------------------
modifier_item_abyss_horn = modifier_item_abyss_horn or class({})

function modifier_item_abyss_horn:IsHidden() return true end
function modifier_item_abyss_horn:IsDebuff() return false end
function modifier_item_abyss_horn:IsPurgable() return false end
function modifier_item_abyss_horn:IsPurgeException() return false end
function modifier_item_abyss_horn:RemoveOnDeath() return false end

function modifier_item_abyss_horn:GetAttributes()
    return MODIFIER_ATTRIBUTE_MULTIPLE
end
function modifier_item_abyss_horn:DeclareFunctions()
	local func =    { 
	                    MODIFIER_PROPERTY_STATS_STRENGTH_BONUS,
                        MODIFIER_PROPERTY_STATS_AGILITY_BONUS,
                        MODIFIER_PROPERTY_STATS_INTELLECT_BONUS,
                        MODIFIER_PROPERTY_MOVESPEED_BONUS_CONSTANT,
                        MODIFIER_PROPERTY_PREATTACK_BONUS_DAMAGE,
                        MODIFIER_PROPERTY_HEALTH_BONUS,
                        MODIFIER_PROPERTY_PHYSICAL_ARMOR_BONUS,
                        MODIFIER_PROPERTY_SPELL_AMPLIFY_PERCENTAGE,
                        MODIFIER_PROPERTY_MANA_BONUS,
					}
	
	return func
end
function modifier_item_abyss_horn:GetModifierPreAttack_BonusDamage()
    return self:GetAbility():GetSpecialValueFor('attack')
end
function modifier_item_abyss_horn:GetModifierManaBonus()
    return self:GetAbility():GetSpecialValueFor('mana')
end
function modifier_item_abyss_horn:GetModifierHealthBonus()
    return self:GetAbility():GetSpecialValueFor('mana')
end
function modifier_item_abyss_horn:GetModifierMoveSpeedBonus_Constant()
	return 20
end
function modifier_item_abyss_horn:GetModifierBonusStats_Strength()
    return self:GetAbility():GetSpecialValueFor('all_stats')
end
function modifier_item_abyss_horn:GetModifierBonusStats_Agility()
    return self:GetAbility():GetSpecialValueFor('all_stats')
end
function modifier_item_abyss_horn:GetModifierBonusStats_Intellect()
    return self:GetAbility():GetSpecialValueFor('all_stats')
end


---------------------------------------------------------------------------------------------------------------------
modifier_abyss_horn_cd = modifier_abyss_horn_cd or class({})

function modifier_abyss_horn_cd:IsHidden() return false end
function modifier_abyss_horn_cd:IsDebuff() return false end
function modifier_abyss_horn_cd:IsPurgable() return false end
function modifier_abyss_horn_cd:IsPurgeException() return false end
function modifier_abyss_horn_cd:RemoveOnDeath() return false end



-----------------------------------------------------------------------
modifier_hero_route_1 = modifier_hero_route_1 or class({})

function modifier_hero_route_1:IsHidden() return false end
function modifier_hero_route_1:RemoveOnDeath() return true end
function modifier_hero_route_1:AllowIllusionDuplicate() return true end
function modifier_hero_route_1:IsPurgable() return false end
function modifier_hero_route_1:DeclareFunctions()
    local funcs = {
                      MODIFIER_PROPERTY_PREATTACK_BONUS_DAMAGE,
		              MODIFIER_PROPERTY_HEALTH_BONUS,
		              MODIFIER_EVENT_ON_ATTACK_LANDED,
                  }

    return funcs
end
function modifier_hero_route_1:OnCreated()
    self.parent = self:GetParent()
    self.player = PlayerResource:GetPlayer(self.parent:GetPlayerID())
    
	Horn_StopAllMusic(self.parent)
    EmitSoundOnClient("horn.hero_1", self.player) 
end
function modifier_hero_route_1:OnDestroy()
    StopSoundOn("horn.hero_1", self.player)
    
	self.ability = self:GetAbility()
	self.ability:EndCooldown()
	self.ability:StartCooldown(30)	
end
function modifier_hero_route_1:OnAttackLanded(params)
	if IsServer() then
	self.crit_chance = 25
		if params.attacker == self:GetParent() then	
			if not params.attacker:IsIllusion() then
			    if RandomInt(0, 100)<self.crit_chance then
			    local caster = self:GetParent()
			    local damage =  caster:GetBaseDamageMax()
	
			    local damageTable = {
		               attacker = self:GetParent(),
		               damage = damage,
		               damage_type = DAMAGE_TYPE_PHYSICAL,
		               ability = self,
	                }
	
	            damageTable.victim = params.target
		        ApplyDamage(damageTable)
		        self:GetParent():EmitSound("halo.attack")
			    end
		    end
	    end
	end
end
function modifier_hero_route_1:GetModifierPreAttack_BonusDamage()
    return 0
end
function modifier_hero_route_1:GetModifierHealthBonus()
	return 200
end
function modifier_hero_route_1:GetTexture()
	return "angel_halo"
end
function modifier_hero_route_1:GetEffectName()
	return "particles/halo_stage_0.vpcf"
end


modifier_hero_route_2 = modifier_hero_route_2 or class({})

function modifier_hero_route_2:IsHidden() return false end
function modifier_hero_route_2:RemoveOnDeath() return true end
function modifier_hero_route_2:AllowIllusionDuplicate() return true end
function modifier_hero_route_2:IsPurgable() return false end
function modifier_hero_route_2:OnCreated()
    self.parent = self:GetParent()
    self.player = PlayerResource:GetPlayer(self.parent:GetPlayerID())
    
	Horn_StopAllMusic(self.parent)
    EmitSoundOnClient("horn.hero_2", self.player) 
end
function modifier_hero_route_2:OnDestroy()
    StopSoundOn("horn.hero_2", self.player)
    
	self.ability = self:GetAbility()
	self.ability:EndCooldown()
	self.ability:StartCooldown(35)	
end

function modifier_hero_route_2:DeclareFunctions()
    local funcs = {
                      MODIFIER_PROPERTY_PREATTACK_BONUS_DAMAGE,
		              MODIFIER_PROPERTY_HEALTH_BONUS,
		              MODIFIER_EVENT_ON_ATTACK_LANDED,
                  }

    return funcs
end
function modifier_hero_route_2:OnAttackLanded(params)
	if IsServer() then	
		if params.attacker == self:GetParent() then	
			if not params.attacker:IsIllusion() then
			   local caster = self:GetParent()
			   local damage = 1/100*self:GetParent():GetHealth()
			   local damageTable = {
		              attacker = self:GetParent(),
		              damage = damage,
		              damage_type = DAMAGE_TYPE_PHYSICAL,
		              ability = self,
	                }
	           damageTable.victim = params.target
	           ApplyDamage(damageTable)
		    end
		end
	end
end
function modifier_hero_route_2:GetModifierPreAttack_BonusDamage()
    return 0
end
function modifier_hero_route_2:GetModifierHealthBonus()
    return 300
end
function modifier_hero_route_2:GetTexture()
	return "angel_halo"
end
function modifier_hero_route_2:GetEffectName()
	return "particles/halo_stage_2.vpcf"
end


modifier_hero_route_3 = class({})

function modifier_hero_route_3:IsHidden() return false end
function modifier_hero_route_3:RemoveOnDeath() return true end
function modifier_hero_route_3:AllowIllusionDuplicate() return true end
function modifier_hero_route_3:IsPurgable() return false end
function modifier_hero_route_3:OnCreated()
    self.parent = self:GetParent()
    self.player = PlayerResource:GetPlayer(self.parent:GetPlayerID())
	
    Horn_StopAllMusic(self.parent)
    EmitSoundOnClient("horn.hero_3", self.player) 
end
function modifier_hero_route_3:OnDestroy()
    StopSoundOn("horn.hero_3", self.player)
    
	self.ability = self:GetAbility()
	self.ability:EndCooldown()
	self.ability:StartCooldown(40)	
end
function modifier_hero_route_3:DeclareFunctions()
    local funcs = {
                      MODIFIER_PROPERTY_PREATTACK_BONUS_DAMAGE,
		              MODIFIER_PROPERTY_HEALTH_BONUS,
		              MODIFIER_EVENT_ON_ATTACK_LANDED,
                  }

    return funcs
end
function modifier_hero_route_3:OnAttackLanded(params)
	if IsServer() then	
		if params.attacker == self:GetParent() then	
			if not params.attacker:IsIllusion() then
			   local caster = self:GetParent()
			   local damage = 1.5/100*self:GetParent():GetHealth()
			   local damageTable = {
		              attacker = self:GetParent(),
		              damage = damage,
		              damage_type = DAMAGE_TYPE_PHYSICAL,
		              ability = self,
	                }
	           damageTable.victim = params.target
		       ApplyDamage(damageTable)
			end
		end
	end
end
function modifier_hero_route_3:GetModifierPreAttack_BonusDamage()
    return 0
end
function modifier_hero_route_3:GetModifierHealthBonus()
	return 400
end
function modifier_hero_route_3:GetTexture()
	return "angel_halo"
end
function modifier_hero_route_3:GetEffectName()
	return "particles/halo_stage_4.vpcf"
end


modifier_hero_route_4 = class({})

function modifier_hero_route_4:IsHidden() return false end
function modifier_hero_route_4:RemoveOnDeath() return true end
function modifier_hero_route_4:AllowIllusionDuplicate() return true end
function modifier_hero_route_4:IsPurgable() return false end
function modifier_hero_route_4:OnCreated()
    self.parent = self:GetParent()
    self.player = PlayerResource:GetPlayer(self.parent:GetPlayerID())
    
	Horn_StopAllMusic(self.parent)
	EmitSoundOnClient("horn.hero_4", self.player) 
end
function modifier_hero_route_4:OnDestroy()
    StopSoundOn("horn.hero_4", self.player)
    self.ability = self:GetAbility()
	self.ability:EndCooldown()
	self.ability:StartCooldown(45)	
end
function modifier_hero_route_4:DeclareFunctions()
    local funcs = {
                      MODIFIER_PROPERTY_PREATTACK_BONUS_DAMAGE,
		              MODIFIER_PROPERTY_HEALTH_BONUS,
		              MODIFIER_EVENT_ON_ATTACK_LANDED,
		          }

    return funcs
end
function modifier_hero_route_4:OnAttackLanded(params)
	if IsServer() then	
		if params.attacker == self:GetParent() then	
			if not params.attacker:IsIllusion() then
			   local caster = self:GetParent()
			   local max_health = self:GetParent():GetMaxHealth()
			   local health = self:GetParent():GetHealth()
			   local damage = (max_health - health) * 0.03
			   local damageTable = {
		              attacker = self:GetParent(),
		              damage = damage,
		              damage_type = DAMAGE_TYPE_PHYSICAL,
		              ability = self,
	                }
	           damageTable.victim = params.target
		       ApplyDamage(damageTable)
			end
		end
	end
end	
function modifier_hero_route_4:GetModifierPreAttack_BonusDamage()
    return 0
end
function modifier_hero_route_4:GetModifierHealthBonus()
	return 500
end
function modifier_hero_route_4:GetTexture()
	return "angel_halo"
end
function modifier_hero_route_4:GetEffectName()
	return "particles/halo_stage_9_alt.vpcf"
end


-------------------------------------------------
modifier_hero_route_5 = class({})

function modifier_hero_route_5:IsHidden() return false end
function modifier_hero_route_5:RemoveOnDeath() return true end
function modifier_hero_route_5:AllowIllusionDuplicate() return false end
function modifier_hero_route_5:IsPurgable() return false end
function modifier_hero_route_5:OnCreated(kv)
    local caster = self:GetCaster()
    self.shit  = RandomInt(1,4)
    self.parent = self:GetParent()
    self.player = PlayerResource:GetPlayer(self.parent:GetPlayerID())
    local delay = 0.02

    Timers:CreateTimer(delay,function()
      if self.shit == 1 then
        self.shit_time  =   ParticleManager:CreateParticle("particles/water_halo.vpcf", PATTACH_ABSORIGIN_FOLLOW, self.parent)
		self.shit_time2 =   ParticleManager:CreateParticle("particles/spirit_overhead1.vpcf", PATTACH_OVERHEAD_FOLLOW, self.parent)
        caster:AddNewModifier(caster, self, "modifier_halo_spirits_stats_1", {duration = 60})  
        self:PlayEffects(300, "particles/water_halo_start.vpcf")

      elseif self.shit == 2 then
        self.shit_time3 =   ParticleManager:CreateParticle("particles/earth_halo.vpcf", PATTACH_ABSORIGIN_FOLLOW, self.parent)
        self.shit_time4 =   ParticleManager:CreateParticle("particles/spirit_overhead3.vpcf", PATTACH_OVERHEAD_FOLLOW, self.parent)                         
        caster:AddNewModifier(caster, self, "modifier_halo_spirits_stats_2", {duration = 60})
        self:PlayEffects(300, "particles/earth_halo_start.vpcf")
		
     elseif self.shit == 3 then
        self.shit_time5 =   ParticleManager:CreateParticle("particles/wind_halo.vpcf", PATTACH_ABSORIGIN_FOLLOW, self.parent)
        self.shit_time6 =   ParticleManager:CreateParticle("particles/spirit_overhead2.vpcf", PATTACH_OVERHEAD_FOLLOW, self.parent)                             
        caster:AddNewModifier(caster, self, "modifier_halo_spirits_stats_3", {duration = 60})
        self:PlayEffects(300, "particles/wind_halo_start.vpcf")
     
	 elseif self.shit == 4 then
        self.shit_time7 =   ParticleManager:CreateParticle("particles/fire_halo.vpcf", PATTACH_ABSORIGIN_FOLLOW, self.parent)
        self.shit_time8 =   ParticleManager:CreateParticle("particles/spirit_overhead4.vpcf", PATTACH_OVERHEAD_FOLLOW, self.parent)
		caster:AddNewModifier(caster, self, "modifier_halo_spirits_stats_4", {duration = 60})
        self:PlayEffects(300, "particles/fire_halo_start.vpcf")		
      end			
    end)	 
        
    if IsServer() then
      Horn_StopAllMusic(self.parent)
      
	  EmitSoundOnClient("horn.hero_5", self.player) 
	end
end
function modifier_hero_route_5:OnRefresh()
end
function modifier_hero_route_5:PlayEffects( radius, sParticleName )
	local particle_cast = sParticleName

	-- Create Particle
	local effect_cast = ParticleManager:CreateParticle( particle_cast, PATTACH_WORLDORIGIN, self:GetParent() )
	ParticleManager:SetParticleControl( effect_cast, 0, self:GetParent():GetOrigin() )
	ParticleManager:SetParticleControl( effect_cast, 1, Vector( radius, radius, radius ) )
	ParticleManager:ReleaseParticleIndex( effect_cast )
end
function modifier_hero_route_5:OnDestroy()
        if self.shit_time then
        ParticleManager:DestroyParticle(self.shit_time, false)
        ParticleManager:ReleaseParticleIndex(self.shit_time)
		end
        for i = 2, 8 do
          if self["shit_time" .. i] then
          ParticleManager:DestroyParticle(self["shit_time" .. i], false)
          ParticleManager:ReleaseParticleIndex(self["shit_time" .. i])
          end
        end
		
        StopSoundOn("horn.hero_5", self.player)
			
		self.ability = self:GetAbility()
	    self.ability:EndCooldown()
	    self.ability:StartCooldown(80)	
end
function modifier_hero_route_5:DeclareFunctions()
    local funcs = {
                      MODIFIER_PROPERTY_PREATTACK_BONUS_DAMAGE,
	                  MODIFIER_EVENT_ON_ATTACK_LANDED,
	                  MODIFIER_PROPERTY_MAGICAL_RESISTANCE_BONUS,
                      MODIFIER_PROPERTY_PHYSICAL_ARMOR_BONUS,
					  MODIFIER_PROPERTY_MOVESPEED_BONUS_CONSTANT,
					  MODIFIER_PROPERTY_ATTACKSPEED_BONUS_CONSTANT,
                  }

    return funcs
end
function modifier_hero_route_5:OnAttackLanded(params)
	if IsServer() then
		if params.attacker == self:GetParent() then	
			if not params.attacker:IsIllusion() then
			   if self.shit == 1 then
			      local damageTable = {
		                 attacker = self:GetParent(),
		                 damage =  0,
		                 damage_type = DAMAGE_TYPE_MAGICAL,
		                 ability = self,
	                   }
	
			      damageTable.victim = params.target
		          ApplyDamage(damageTable)
			      params.target:AddNewModifier(self:GetCaster(), self:GetAbility(), "modifier_halo_water", {duration = 3 })

			   elseif self.shit == 2 then
			      params.target:AddNewModifier(self:GetCaster(), self:GetAbility(), "modifier_halo_earth", {duration = 3 })
		
			   elseif self.shit == 3 then
			      params.target:AddNewModifier(self:GetCaster(), self:GetAbility(), "modifier_halo_wind", {duration = 2 })
			   else
			      params.target:AddNewModifier(self:GetCaster(), self:GetAbility(), "modifier_halo_fire", {duration = 3 })
			
			   end
		    end
	    end
	end
end
function modifier_hero_route_5:GetTexture()
	return "angel_halo"
end


modifier_halo_wind = class({})

function modifier_halo_wind:IsHidden() return false end
function modifier_halo_wind:RemoveOnDeath() return true end
function modifier_halo_wind:AllowIllusionDuplicate() return true end
function modifier_halo_wind:IsPurgable() return false end
function modifier_halo_wind:DeclareFunctions()
    local funcs = {
                      MODIFIER_PROPERTY_MOVESPEED_BONUS_CONSTANT,
		          }

    return funcs
end

function modifier_halo_wind:GetModifierMoveSpeedBonus_Constant()
	return -75
end
function modifier_halo_wind:GetTexture()
	return "angel_halo"
end
function modifier_halo_wind:GetEffectName()
	return "particles/econ/items/windrunner/windranger_arcana/windranger_arcana_hud_ambient.vpcf"
end


modifier_halo_earth = class({})

function modifier_halo_earth:IsHidden() return false end
function modifier_halo_earth:RemoveOnDeath() return true end
function modifier_halo_earth:AllowIllusionDuplicate() return true end
function modifier_halo_earth:IsPurgable() return false end
function modifier_halo_earth:DeclareFunctions()
    local funcs = {
                      MODIFIER_PROPERTY_PHYSICAL_ARMOR_BONUS, 
                  }

    return funcs
end

function modifier_halo_earth:GetModifierPhysicalArmorBonus()
    return -10
end
function modifier_halo_earth:GetTexture()
	return "angel_halo"
end
function modifier_halo_earth:GetEffectName()
	return "particles/earth_halo_debuff.vpcf"
end


modifier_halo_water = class({})

function modifier_halo_water:IsHidden() return false end
function modifier_halo_water:RemoveOnDeath() return true end
function modifier_halo_water:AllowIllusionDuplicate() return false end
function modifier_halo_water:IsPurgable() return false end
function modifier_halo_water:DeclareFunctions()
    local funcs = {
                      MODIFIER_PROPERTY_MAGICAL_RESISTANCE_BONUS,
                      MODIFIER_PROPERTY_PHYSICAL_ARMOR_BONUS, 		
                  }

    return funcs
end
function modifier_halo_water:GetModifierMagicalResistanceBonus()
    return -20
end
function modifier_halo_water:GetTexture()
	return "angel_halo"
end
function modifier_halo_water:GetEffectName()
	return "particles/water_halo_debuff.vpcf"
end


modifier_halo_fire = class({})

--------------------------------------------------------------------------------
-- Classifications
function modifier_halo_fire:IsHidden() return false end
function modifier_halo_fire:IsDebuff() return true end
function modifier_halo_fire:IsStunDebuff() return false end
function modifier_halo_fire:IsPurgable() return true end
--------------------------------------------------------------------------------
-- Initializations
function modifier_halo_fire:OnCreated( kv )
	-- references
	local damage = 0
	
	if not IsServer() then return end

	-- precache damage
	self.damageTable = {
		victim = self:GetParent(),
		attacker = self:GetCaster(),
		damage = damage,
		damage_type = DAMAGE_TYPE_PURE,
		ability = self:GetAbility(), --Optional.
	}
	-- ApplyDamage(damageTable)

	-- Start interval
	self:StartIntervalThink( 1 )
end
function modifier_halo_fire:OnRefresh( kv )
	-- references
	local damage = 0
	
	if not IsServer() then return end

	-- update damage
	self.damageTable.damage = damage	
end
function modifier_halo_fire:OnRemoved()
end
function modifier_halo_fire:OnDestroy()
end
-- Interval Effects
function modifier_halo_fire:OnIntervalThink()
	ApplyDamage( self.damageTable )
end
--------------------------------------------------------------------------------
-- Graphics & Animations
function modifier_halo_fire:GetEffectName()
	return "particles/econ/items/clinkz/clinkz_ti9_immortal/clinkz_ti9_summon_army.vpcf"
end

function modifier_halo_fire:GetEffectAttachType()
	return PATTACH_ABSORIGIN_FOLLOW
end


modifier_halo_spirits_stats_1 = class({})

function modifier_halo_spirits_stats_1:IsHidden() return true end
function modifier_halo_spirits_stats_1:RemoveOnDeath() return true end
function modifier_halo_spirits_stats_1:AllowIllusionDuplicate() return false end
function modifier_halo_spirits_stats_1:IsPurgable() return false end
function modifier_halo_spirits_stats_1:DeclareFunctions()
    local funcs = {
	                  MODIFIER_PROPERTY_MAGICAL_RESISTANCE_BONUS,
	                  MODIFIER_PROPERTY_HEALTH_BONUS, 
                  }

    return funcs
end
function modifier_halo_spirits_stats_1:GetModifierMagicalResistanceBonus()
    return 0
end
function modifier_halo_spirits_stats_1:GetModifierHealthBonus()
	return 600
end


modifier_halo_spirits_stats_2 = class({})

function modifier_halo_spirits_stats_2:IsHidden() return true end
function modifier_halo_spirits_stats_2:RemoveOnDeath() return true end
function modifier_halo_spirits_stats_2:AllowIllusionDuplicate() return false end
function modifier_halo_spirits_stats_2:IsPurgable() return false end
function modifier_halo_spirits_stats_2:DeclareFunctions()
    local funcs = {
	                  MODIFIER_PROPERTY_PHYSICAL_ARMOR_BONUS,
	                  MODIFIER_PROPERTY_HEALTH_BONUS,   
                  }

    return funcs
end
function modifier_halo_spirits_stats_2:GetModifierPhysicalArmorBonus()
    return 5
end
function modifier_halo_spirits_stats_2:GetModifierHealthBonus()
	return 600
end


modifier_halo_spirits_stats_3 = class({})

function modifier_halo_spirits_stats_3:IsHidden() return true end
function modifier_halo_spirits_stats_3:RemoveOnDeath() return true end
function modifier_halo_spirits_stats_3:AllowIllusionDuplicate() return false end
function modifier_halo_spirits_stats_3:IsPurgable() return false end
function modifier_halo_spirits_stats_3:DeclareFunctions()
    local funcs = {
	                  MODIFIER_PROPERTY_MOVESPEED_BONUS_CONSTANT,
					  MODIFIER_PROPERTY_ATTACKSPEED_BONUS_CONSTANT,
					  MODIFIER_PROPERTY_HEALTH_BONUS,     
		          }

    return funcs
end
function modifier_halo_spirits_stats_3:GetModifierMoveSpeedBonus_Constant()
	return 30
end
function modifier_halo_spirits_stats_3:GetModifierAttackSpeedBonus_Constant()
	 return 0
end
function modifier_halo_spirits_stats_3:GetModifierHealthBonus()
	return 600
end


modifier_halo_spirits_stats_4 = class({})

function modifier_halo_spirits_stats_4:IsHidden() return true end
function modifier_halo_spirits_stats_4:RemoveOnDeath() return true end
function modifier_halo_spirits_stats_4:AllowIllusionDuplicate() return false end
function modifier_halo_spirits_stats_4:IsPurgable() return false end
function modifier_halo_spirits_stats_4:DeclareFunctions()
    local funcs = {
                      MODIFIER_PROPERTY_PREATTACK_BONUS_DAMAGE,
                      MODIFIER_PROPERTY_HEALTH_BONUS, 		
                  }

    return funcs
end
function modifier_halo_spirits_stats_4:GetModifierHealthBonus()
	return 600
end
function modifier_halo_spirits_stats_4:GetModifierPreAttack_BonusDamage()
    return 0
end


--------------------------------------------------
modifier_hero_route_6 = class({})

function modifier_hero_route_6:IsHidden() return false end
function modifier_hero_route_6:RemoveOnDeath() return true end
function modifier_hero_route_6:AllowIllusionDuplicate() return true end
function modifier_hero_route_6:IsPurgable() return false end
function modifier_hero_route_6:OnCreated()
    self.parent = self:GetParent()
    self.player = PlayerResource:GetPlayer(self.parent:GetPlayerID())
	
	Horn_StopAllMusic(self.parent)
	self:PlayEffects()
    EmitSoundOnClient("horn.hero_6", self.player) 
    self.heal = self.parent:GetMaxHealth()
	self.heal1 = self.heal * 0.01
	self.radius = 600

	self:StartIntervalThink( 1 )
 end
function modifier_hero_route_6:OnIntervalThink()
	local ally = FindUnitsInRadius(
		self:GetParent():GetTeamNumber(),	-- int, your team number
		self:GetParent():GetOrigin(),	-- point, center point
		nil,	-- handle, cacheUnit. (not known)
		600,	-- float, radius. or use FIND_UNITS_EVERYWHERE
		DOTA_UNIT_TARGET_TEAM_FRIENDLY,	-- int, team filter
		DOTA_UNIT_TARGET_HERO + DOTA_UNIT_TARGET_BASIC,	-- int, type filter
		0,	-- int, flag filter
		0,	-- int, order filter
		false	-- bool, can grow cache
	)

	for _,baka in pairs(ally) do
		-- apply damage
		baka:Heal( self.heal1, self:GetParent() )
	end
end
function modifier_hero_route_6:PlayEffects()
	-- get resources
	local particle_cast = "particles/hero_6_flash.vpcf"
	
	-- play particle
	local effect_cast = ParticleManager:CreateParticle( particle_cast, PATTACH_ABSORIGIN, self:GetParent() )
	ParticleManager:SetParticleControl( effect_cast, 0, self:GetParent():GetOrigin() )
	ParticleManager:SetParticleControl( effect_cast, 1, Vector( self.reincarnate_time, 0, 0 ) )
	ParticleManager:ReleaseParticleIndex( effect_cast )
end
function modifier_hero_route_6:OnDestroy()
    StopSoundOn("horn.hero_6", self.player) 
    
	self.ability = self:GetAbility()
	self.ability:EndCooldown()
	self.ability:StartCooldown(60)	
end

function modifier_hero_route_6:DeclareFunctions()
    local funcs = {
                      MODIFIER_PROPERTY_PREATTACK_BONUS_DAMAGE,
		              MODIFIER_PROPERTY_HEALTH_BONUS,
		              MODIFIER_EVENT_ON_ATTACK_LANDED,
                  }

    return funcs
end
function modifier_hero_route_6:OnAttackLanded(params)
	if IsServer() then	
		if params.attacker == self:GetParent() then	
			if not params.attacker:IsIllusion() then
			   local caster = self:GetParent()
			   local max_health = self:GetParent():GetMaxHealth()
			   local health = self:GetParent():GetHealth()
			   local damage = (max_health - health) * 0.05
			   local damageTable = {
		              attacker = self:GetParent(),
		              damage = damage,
		              damage_type = DAMAGE_TYPE_PHYSICAL,
		              ability = self,
	                }
			   damageTable.victim = params.target
			   ApplyDamage(damageTable)
			end
		end
	end
end
function modifier_hero_route_6:GetModifierPreAttack_BonusDamage()
    return 0
end
function modifier_hero_route_6:GetModifierHealthBonus()
	return 500
end
function modifier_hero_route_6:GetTexture()
	return "angel_halo"
end
function modifier_hero_route_6:GetEffectName()
	return "particles/halo_stage_9_hero.vpcf"
end


---------------------------------------------------------
modifier_demon_route_1 = class({})

function modifier_demon_route_1:IsHidden() return false end
function modifier_demon_route_1:RemoveOnDeath() return true end
function modifier_demon_route_1:AllowIllusionDuplicate() return true end
function modifier_demon_route_1:IsPurgable() return false end
function modifier_demon_route_1:OnCreated()
    self.parent = self:GetParent()
    self.player = PlayerResource:GetPlayer(self.parent:GetPlayerID())
	
	Horn_StopAllMusic(self.parent)
	EmitSoundOnClient("horn.demon_1", self.player) 
end
function modifier_demon_route_1:OnDestroy()
    StopSoundOn("horn.demon_1", self.player)
    
	self.ability = self:GetAbility()
	self.ability:EndCooldown()
	self.ability:StartCooldown(30)	
end

function modifier_demon_route_1:DeclareFunctions()
    local funcs = {
                      MODIFIER_PROPERTY_PREATTACK_BONUS_DAMAGE,
		              MODIFIER_PROPERTY_HEALTH_BONUS,
		              MODIFIER_EVENT_ON_ATTACK_LANDED,
                  }

    return funcs
end
function modifier_demon_route_1:OnAttackLanded(params)
	if IsServer() then	
		if params.attacker == self:GetParent() then	
			if not params.attacker:IsIllusion() then
			   local caster = self:GetParent()
			   local max_health = self:GetParent():GetMaxHealth()
			   local health = self:GetParent():GetHealth()
			   local damage = 30
			   local damageTable = {
		              attacker = self:GetParent(),
		              damage = damage,
		              damage_type = DAMAGE_TYPE_MAGICAL,
		              ability = self,
	                }
			   damageTable.victim = params.target
		       ApplyDamage(damageTable)
		       self.crit_chance = 1
		        if RandomInt(0, 100)<self.crit_chance then
		           params.target:AddNewModifier(self:GetCaster(), self:GetAbility(), "modifier_halo_slow", {duration = 2 })
			    end
			end
		end
	end
end
function modifier_demon_route_1:GetTexture()
	return "angel_halo"
end
function modifier_demon_route_1:GetEffectName()
	return "particles/halo_stage_9_1.vpcf"
end


modifier_demon_route_2 = class({})

function modifier_demon_route_2:IsHidden() return false end
function modifier_demon_route_2:RemoveOnDeath() return true end
function modifier_demon_route_2:AllowIllusionDuplicate() return true end
function modifier_demon_route_2:IsPurgable() return false end
function modifier_demon_route_2:OnCreated()
    self.parent = self:GetParent()
    self.player = PlayerResource:GetPlayer(self.parent:GetPlayerID())
	
	Horn_StopAllMusic(self.parent)
	EmitSoundOnClient("horn.demon_2", self.player) 
end
function modifier_demon_route_2:OnDestroy()
    StopSoundOn("horn.demon_2", self.player)
    
	self.ability = self:GetAbility()
	self.ability:EndCooldown()
	self.ability:StartCooldown(35)	
end

function modifier_demon_route_2:DeclareFunctions()
    local funcs = {
                      MODIFIER_PROPERTY_PREATTACK_BONUS_DAMAGE,
		              MODIFIER_PROPERTY_HEALTH_BONUS,
		              MODIFIER_EVENT_ON_ATTACK_LANDED,
                  }

    return funcs
end
function modifier_demon_route_2:OnAttackLanded(params)
	if IsServer() then	
		if params.attacker == self:GetParent() then	
			if not params.attacker:IsIllusion() then
			   local caster = self:GetParent()
			   local max_health = self:GetParent():GetMaxHealth()
			   local health = self:GetParent():GetHealth()
			   local damage = 30
			   local damageTable = {
		              attacker = self:GetParent(),
		              damage = damage,
		              damage_type = DAMAGE_TYPE_MAGICAL,
		              ability = self,
	                }
			   damageTable.victim = params.target
		       ApplyDamage(damageTable)
		       self.crit_chance = 2
		        if RandomInt(0, 100)<self.crit_chance then
		          params.target:AddNewModifier(self:GetCaster(), self:GetAbility(), "modifier_halo_slow", {duration = 2 })
			    end
			end
		end
	end
end	
function modifier_demon_route_2:GetTexture()
	return "angel_halo"
end
function modifier_demon_route_2:GetEffectName()
	return "particles/halo_stage_9_2_1.vpcf"
end


modifier_demon_route_3 = class({})

function modifier_demon_route_3:IsHidden() return false end
function modifier_demon_route_3:RemoveOnDeath() return true end
function modifier_demon_route_3:AllowIllusionDuplicate() return true end
function modifier_demon_route_3:IsPurgable() return false end
function modifier_demon_route_3:OnCreated()
    self.parent = self:GetParent()
    self.player = PlayerResource:GetPlayer(self.parent:GetPlayerID())
	
	Horn_StopAllMusic(self.parent)
	EmitSoundOnClient("horn.demon_3", self.player) 
end
function modifier_demon_route_3:OnDestroy()
    StopSoundOn("horn.demon_3", self.player)
    
	self.ability = self:GetAbility()
	self.ability:EndCooldown()
	self.ability:StartCooldown(40)	
end
function modifier_demon_route_3:DeclareFunctions()
    local funcs = {
                      MODIFIER_PROPERTY_PREATTACK_BONUS_DAMAGE,
		              MODIFIER_PROPERTY_HEALTH_BONUS,
		              MODIFIER_EVENT_ON_ATTACK_LANDED,
                  }

    return funcs
end
function modifier_demon_route_3:OnAttackLanded(params)
	if IsServer() then	
		if params.attacker == self:GetParent() then	
			if not params.attacker:IsIllusion() then
			   local caster = self:GetParent()
			   local max_health = self:GetParent():GetMaxHealth()
			   local health = self:GetParent():GetHealth()
			   local damage = 30
			   local damageTable = {
		              attacker = self:GetParent(),
		              damage = damage,
		              damage_type = DAMAGE_TYPE_MAGICAL,
		              ability = self,
	                }
			   damageTable.victim = params.target
			   ApplyDamage(damageTable)
			   self.crit_chance = 2
			    if RandomInt(0, 100)<self.crit_chance then
			      params.target:AddNewModifier(self:GetCaster(), self:GetAbility(), "modifier_halo_root", {duration = 0.8 })
			    end
			end
		end
	end
end
function modifier_demon_route_3:GetTexture()
	return "angel_halo"
end
function modifier_demon_route_3:GetEffectName()
	return "particles/halo_stage_8.vpcf"
end


modifier_demon_route_4 = class({})

function modifier_demon_route_4:IsHidden() return false end
function modifier_demon_route_4:RemoveOnDeath() return true end
function modifier_demon_route_4:AllowIllusionDuplicate() return true end
function modifier_demon_route_4:IsPurgable() return false end
function modifier_demon_route_4:OnCreated()
    self.parent = self:GetParent()
    self.player = PlayerResource:GetPlayer(self.parent:GetPlayerID())
	
	Horn_StopAllMusic(self.parent)
	EmitSoundOnClient("horn.demon_4", self.player) 
 end
function modifier_demon_route_4:OnDestroy()
    StopSoundOn("horn.demon_4", self.player)
    
	self.ability = self:GetAbility()
	self.ability:EndCooldown()
	self.ability:StartCooldown(45)	
end
function modifier_demon_route_4:DeclareFunctions()
    local funcs = {
                      MODIFIER_PROPERTY_PREATTACK_BONUS_DAMAGE,
		              MODIFIER_PROPERTY_HEALTH_BONUS,
		              MODIFIER_EVENT_ON_ATTACK_LANDED,
                  }

    return funcs
end
function modifier_demon_route_4:OnAttackLanded(params)
	if IsServer() then	
		if params.attacker == self:GetParent() then	
			if not params.attacker:IsIllusion() then
			   local caster = self:GetParent()
			   local max_health = self:GetParent():GetMaxHealth()
			   local health = self:GetParent():GetHealth()
			   local damage = 30
			   local damageTable = {
		              attacker = self:GetParent(),
		              damage = damage,
		              damage_type = DAMAGE_TYPE_MAGICAL,
		              ability = self,
	                }
			   damageTable.victim = params.target
			   ApplyDamage(damageTable)
			   self.crit_chance = 2
			    if RandomInt(0, 100)<self.crit_chance then
			      params.target:AddNewModifier(self:GetCaster(), self:GetAbility(), "modifier_halo_root", {duration = 0.8 })
			    end
			end
		end
	end
end
function modifier_demon_route_4:GetTexture()
	return "angel_halo"
end
function modifier_demon_route_4:GetEffectName()
	return "particles/halo_lust_armor_sealed.vpcf"
end


modifier_demon_route_5 = class({})

function modifier_demon_route_5:IsHidden() return false end
function modifier_demon_route_5:RemoveOnDeath() return true end
function modifier_demon_route_5:AllowIllusionDuplicate() return true end
function modifier_demon_route_5:IsPurgable() return false end
function modifier_demon_route_5:OnCreated()
    self.parent = self:GetParent()
    self.player = PlayerResource:GetPlayer(self.parent:GetPlayerID())
	
	Horn_StopAllMusic(self.parent)
    EmitSoundOnClient("horn.demon_5", self.player) 
end
function modifier_demon_route_5:OnDestroy()
    StopSoundOn("horn.demon_5", self.player) 
    
	self.ability = self:GetAbility()
	self.ability:EndCooldown()
	self.ability:StartCooldown(60)	
end

function modifier_demon_route_5:DeclareFunctions()
    local funcs = {
                      MODIFIER_PROPERTY_PREATTACK_BONUS_DAMAGE,
		              MODIFIER_PROPERTY_HEALTH_BONUS,
		              MODIFIER_EVENT_ON_ATTACK_LANDED,
		              MODIFIER_PROPERTY_STATS_STRENGTH_BONUS,
                      MODIFIER_PROPERTY_STATS_AGILITY_BONUS,
                      MODIFIER_PROPERTY_STATS_INTELLECT_BONUS,
                  }

    return funcs
end
function modifier_demon_route_5:GetModifierBonusStats_Strength()
    return 10
end
function modifier_demon_route_5:GetModifierBonusStats_Agility()
    return 10
end
function modifier_demon_route_5:GetModifierBonusStats_Intellect()
    return 10
end
function modifier_demon_route_5:OnAttackLanded(params)
	if IsServer() then	
		if params.attacker == self:GetParent() then	
			if not params.attacker:IsIllusion() then
			   local caster = self:GetParent()
			   local max_health = params.target:GetMaxHealth()
			   self.crit_chance = 5
			    if RandomInt(0, 100)<self.crit_chance then
			      self.damage = max_health * 0.01
			    else
			      self.damage = 100
			    end
			   local damageTable = {
		              attacker = self:GetParent(),
		              damage = self.damage,
		              damage_type = DAMAGE_TYPE_MAGICAL,
		              ability = self,
	                }
			   damageTable.victim = params.target
			   ApplyDamage(damageTable)
			end
		end
	end
end
function modifier_demon_route_5:GetTexture()
	return "angel_halo"
end
function modifier_demon_route_5:GetEffectName()
	return "particles/halo_stage_10_buff.vpcf"
end


modifier_demon_route_6 = class({})

function modifier_demon_route_6:IsHidden() return false end
function modifier_demon_route_6:RemoveOnDeath() return true end
function modifier_demon_route_6:AllowIllusionDuplicate() return true end
function modifier_demon_route_6:IsPurgable() return false end
function modifier_demon_route_6:OnCreated()
    self.parent = self:GetParent()
    self.player = PlayerResource:GetPlayer(self.parent:GetPlayerID())
	
	Horn_StopAllMusic(self.parent)
	EmitSoundOnClient("horn.demon_6", self.player) 
end
function modifier_demon_route_6:OnDestroy()
    StopSoundOn("horn.demon_6", self.player) 
    
	self.ability = self:GetAbility()
	self.ability:EndCooldown()
	self.ability:StartCooldown(60)	
end
function modifier_demon_route_6:DeclareFunctions()
    local funcs = {
                      MODIFIER_PROPERTY_PREATTACK_BONUS_DAMAGE,
		              MODIFIER_PROPERTY_HEALTH_BONUS,
		              MODIFIER_EVENT_ON_ATTACK_LANDED,
		              MODIFIER_PROPERTY_STATS_STRENGTH_BONUS,
                      MODIFIER_PROPERTY_STATS_AGILITY_BONUS,
                      MODIFIER_PROPERTY_STATS_INTELLECT_BONUS,
                  }

    return funcs
end
function modifier_demon_route_6:GetModifierBonusStats_Strength()
    return 10
end
function modifier_demon_route_6:GetModifierBonusStats_Agility()
    return 10
end
function modifier_demon_route_6:GetModifierBonusStats_Intellect()
    return 10
end
function modifier_demon_route_6:OnAttackLanded(params)
	if IsServer() then	
		if params.attacker == self:GetParent() then	
			if not params.attacker:IsIllusion() then
			   local caster = self:GetParent()
			   local max_health = params.target:GetMaxHealth()
			   self.crit_chance = 2
			    if RandomInt(0, 100)<self.crit_chance then
			      self.heal = max_health * 0.01
			      self:GetParent():Heal(self.heal, nil)
		        end
			   self.damage = 30
			   local damageTable = {
		              attacker = self:GetParent(),
		              damage = self.damage,
		              damage_type = DAMAGE_TYPE_MAGICAL,
		              ability = self,
	                }
			   damageTable.victim = params.target
			   ApplyDamage(damageTable)
			end
		end
	end
end
function modifier_demon_route_6:GetTexture()
	return "angel_halo"
end
function modifier_demon_route_6:GetEffectName()
	return "particles/halo_lust_armor_awakened.vpcf"
end


modifier_samurai_route_1 = class({})

function modifier_samurai_route_1:IsHidden() return false end
function modifier_samurai_route_1:RemoveOnDeath() return true end
function modifier_samurai_route_1:AllowIllusionDuplicate() return true end
function modifier_samurai_route_1:IsPurgable() return false end
function modifier_samurai_route_1:OnCreated()
    self.parent = self:GetParent()
    self.player = PlayerResource:GetPlayer(self.parent:GetPlayerID())
	
	Horn_StopAllMusic(self.parent)
    EmitSoundOnClient("horn.samurai_1", self.player) 
 end
function modifier_samurai_route_1:OnDestroy()
    StopSoundOn("horn.samurai_1", self.player)
    
	self.ability = self:GetAbility()
	self.ability:EndCooldown()
	self.ability:StartCooldown(30)	
end
function modifier_samurai_route_1:DeclareFunctions()
    local funcs = {
                      MODIFIER_PROPERTY_PREATTACK_BONUS_DAMAGE,
		              MODIFIER_PROPERTY_PHYSICAL_ARMOR_BONUS,
		              MODIFIER_EVENT_ON_ATTACK_LANDED,
                  }

    return funcs
end
function modifier_samurai_route_1:GetModifierPhysicalArmorBonus()
    return 5
end   
function modifier_samurai_route_1:GetModifierPreAttack_BonusDamage()
    return 100
end 
function modifier_samurai_route_1:OnAttackLanded(params)
	if IsServer() then
	   self.chance = 35
	   if not self:GetParent():HasModifier("modifier_abyss_horn_cd") then
	      if params.target~=self:GetCaster() then return end
	      if params.attacker:GetTeamNumber()==params.target:GetTeamNumber() then return end
		  if RandomInt(1,100)>self.chance then return end
		  if not self:GetParent():IsStunned() then
			self:GetParent():PerformAttack(params.attacker, true,
				true,
				true,
				true,
				true,
				false,
				true)
		  end
	      self:GetParent():AddNewModifier(self:GetParent(), self, "modifier_abyss_horn_cd", {duration = 1.5})
		  self:GetParent():EmitSound("halo.attack")
	   end
	end
end
function modifier_samurai_route_1:GetTexture()
	return "angel_halo"
end
function modifier_samurai_route_1:GetEffectName()
	return "particles/halo_stage_5.vpcf"
end


modifier_samurai_route_2 = class({})

function modifier_samurai_route_2:IsHidden() return false end
function modifier_samurai_route_2:RemoveOnDeath() return true end
function modifier_samurai_route_2:AllowIllusionDuplicate() return true end
function modifier_samurai_route_2:IsPurgable() return false end
function modifier_samurai_route_2:OnCreated()
    self.parent = self:GetParent()
    self.player = PlayerResource:GetPlayer(self.parent:GetPlayerID())
	
	Horn_StopAllMusic(self.parent)
    EmitSoundOnClient("horn.samurai_2", self.player) 
end
function modifier_samurai_route_2:OnDestroy()
    StopSoundOn("horn.samurai_2", self.player)
    
	self.ability = self:GetAbility()
	self.ability:EndCooldown()
	self.ability:StartCooldown(35)	
end
function modifier_samurai_route_2:DeclareFunctions()
    local funcs = {
                      MODIFIER_PROPERTY_PREATTACK_BONUS_DAMAGE,
		              MODIFIER_PROPERTY_PHYSICAL_ARMOR_BONUS,
		              MODIFIER_EVENT_ON_ATTACK_LANDED,
                  }

    return funcs
end
function modifier_samurai_route_2:GetModifierPhysicalArmorBonus()
    return 7
end   
function modifier_samurai_route_2:GetModifierPreAttack_BonusDamage()
    return 125
end 
function modifier_samurai_route_2:OnAttackLanded(params)
	if IsServer() then
	   self.chance = 45
	   if not self:GetParent():HasModifier("modifier_abyss_horn_cd") then
	   if params.target~=self:GetCaster() then return end
	   if params.attacker:GetTeamNumber()==params.target:GetTeamNumber() then return end
	   if RandomInt(1,100)>self.chance then return end
	   if not self:GetParent():IsStunned() then
			self:GetParent():PerformAttack(params.attacker, true,
				true,
				true,
				true,
				true,
				false,
				true)
		end
		self:GetParent():AddNewModifier(self:GetParent(), self, "modifier_abyss_horn_cd", {duration = 1.5})
		self:GetParent():EmitSound("halo.attack")
	   end
	end
end
function modifier_samurai_route_2:GetTexture()
	return "angel_halo"
end
function modifier_samurai_route_2:GetEffectName()
	return "particles/halo_stage_5_samurai_1.vpcf"
end


modifier_samurai_route_3 = class({})

function modifier_samurai_route_3:IsHidden() return false end
function modifier_samurai_route_3:RemoveOnDeath() return true end
function modifier_samurai_route_3:AllowIllusionDuplicate() return true end
function modifier_samurai_route_3:IsPurgable() return false end
function modifier_samurai_route_3:OnCreated()
    self.parent = self:GetParent()
    self.player = PlayerResource:GetPlayer(self.parent:GetPlayerID())
	
	Horn_StopAllMusic(self.parent)
    EmitSoundOnClient("horn.samurai_3", self.player) 
end
function modifier_samurai_route_3:OnDestroy()
    StopSoundOn("horn.samurai_3", self.player)
    
	self.ability = self:GetAbility()
	self.ability:EndCooldown()
	self.ability:StartCooldown(40)	
end

function modifier_samurai_route_3:DeclareFunctions()
    local funcs = {
                      MODIFIER_PROPERTY_PREATTACK_BONUS_DAMAGE,
		              MODIFIER_PROPERTY_PHYSICAL_ARMOR_BONUS,
		              MODIFIER_EVENT_ON_ATTACK_LANDED,
                  }

    return funcs
end
function modifier_samurai_route_3:GetModifierPhysicalArmorBonus()
    return 10
end   
function modifier_samurai_route_3:GetModifierPreAttack_BonusDamage()
    return 150
end 
function modifier_samurai_route_3:OnAttackLanded(params)
	if IsServer() then
	   self.chance = 55
	   if not self:GetParent():HasModifier("modifier_abyss_horn_cd") then
	   if params.target~=self:GetCaster() then return end
	   if params.attacker:GetTeamNumber()==params.target:GetTeamNumber() then return end
	   if RandomInt(1,100)>self.chance then return end
	      if not self:GetParent():IsStunned() then
			self:GetParent():PerformAttack(params.attacker, true,
				true,
				true,
				true,
				true,
				false,
				true)
		   end
		   self:GetParent():AddNewModifier(self:GetParent(), self, "modifier_abyss_horn_cd", {duration = 1.5})
		   self:GetParent():EmitSound("halo.attack")
		end
	end
end
function modifier_samurai_route_3:GetTexture()
	return "angel_halo"
end
function modifier_samurai_route_3:GetEffectName()
	return "particles/halo_stage_5_samurai_2.vpcf"
end


modifier_samurai_route_4 = class({})

function modifier_samurai_route_4:IsHidden() return false end
function modifier_samurai_route_4:RemoveOnDeath() return true end
function modifier_samurai_route_4:AllowIllusionDuplicate() return true end
function modifier_samurai_route_4:OnCreated()
    self.parent = self:GetParent()
    self.player = PlayerResource:GetPlayer(self.parent:GetPlayerID())
	
	Horn_StopAllMusic(self.parent)
	EmitSoundOnClient("horn.samurai_4", self.player) 
end
function modifier_samurai_route_4:OnDestroy()
    StopSoundOn("horn.samurai_4", self.player)
    
	self.ability = self:GetAbility()
	self.ability:EndCooldown()
	self.ability:StartCooldown(45)	
 end
function modifier_samurai_route_4:IsPurgable()
    return false
end

function modifier_samurai_route_4:DeclareFunctions()
    local funcs = {
                      MODIFIER_PROPERTY_PREATTACK_BONUS_DAMAGE,
		              MODIFIER_PROPERTY_PHYSICAL_ARMOR_BONUS,
		              MODIFIER_EVENT_ON_ATTACK_LANDED,
                  }

    return funcs
end
function modifier_samurai_route_4:GetModifierPhysicalArmorBonus()
    return 20
end   
function modifier_samurai_route_4:GetModifierPreAttack_BonusDamage()
    return 220
end 
function modifier_samurai_route_4:OnAttackLanded(params)
	if IsServer() then
	   self.chance = 70
	   if not self:GetParent():HasModifier("modifier_abyss_horn_cd") then
	   if params.target~=self:GetCaster() then return end
	   if params.attacker:GetTeamNumber()==params.target:GetTeamNumber() then return end
	   if RandomInt(1,100)>self.chance then return end
	      if not self:GetParent():IsStunned() then
			self:GetParent():PerformAttack(params.attacker, true,
				true,
				true,
				true,
				true,
				false,
				true)
		  end
		  self:GetParent():AddNewModifier(self:GetParent(), self, "modifier_abyss_horn_cd", {duration = 1.5})
		  self:GetParent():EmitSound("halo.attack")
		end
	end
end
function modifier_samurai_route_4:GetTexture()
	return "angel_halo"
end
function modifier_samurai_route_4:GetEffectName()
	return "particles/halo_stage_5_samurai_3.vpcf"
end


modifier_samurai_route_5 = class({})

function modifier_samurai_route_5:IsHidden() return false end
function modifier_samurai_route_5:RemoveOnDeath() return true end
function modifier_samurai_route_5:AllowIllusionDuplicate() return true end
function modifier_samurai_route_5:IsPurgable() return false end
function modifier_samurai_route_5:OnCreated()
    self.parent = self:GetParent()
    self.player = PlayerResource:GetPlayer(self.parent:GetPlayerID())
	
	Horn_StopAllMusic(self.parent)
	EmitSoundOnClient("horn.samurai_5", self.player) 
    self:PlayEffects()
end
function modifier_samurai_route_5:PlayEffects()
	-- get resources
	local particle_cast = "particles/samurai_flash.vpcf"
	
	-- play particle
	local effect_cast = ParticleManager:CreateParticle( particle_cast, PATTACH_ABSORIGIN, self:GetParent() )
	ParticleManager:SetParticleControl( effect_cast, 0, self:GetParent():GetOrigin() )
	ParticleManager:SetParticleControl( effect_cast, 1, Vector( self.reincarnate_time, 0, 0 ) )
	ParticleManager:ReleaseParticleIndex( effect_cast )
end
function modifier_samurai_route_5:OnDestroy()
    StopSoundOn("horn.samurai_5", self.player) 
    
	self.ability = self:GetAbility()
	self.ability:EndCooldown()
	self.ability:StartCooldown(60)	
end

function modifier_samurai_route_5:DeclareFunctions()
    local funcs = {
                      MODIFIER_PROPERTY_PREATTACK_BONUS_DAMAGE,
		              MODIFIER_PROPERTY_PHYSICAL_ARMOR_BONUS,
		              MODIFIER_EVENT_ON_ATTACK_LANDED,
                  }

    return funcs
end
function modifier_samurai_route_5:GetModifierPhysicalArmorBonus()
    return 15
end   
function modifier_samurai_route_5:GetModifierPreAttack_BonusDamage()
    return 400
end 
function modifier_samurai_route_5:OnAttackLanded(params)
	if IsServer() then
	   self.chance = 100
	   if not self:GetParent():HasModifier("modifier_abyss_horn_cd") then
	   if params.target~=self:GetCaster() then return end
	   if params.attacker:GetTeamNumber()==params.target:GetTeamNumber() then return end
	   if RandomInt(1,100)>self.chance then return end
	      if not self:GetParent():IsStunned() then
			self:GetParent():PerformAttack(params.attacker, true,
				true,
				true,
				true,
				true,
				false,
				true)
	      end
		  self:GetParent():AddNewModifier(self:GetParent(), self, "modifier_abyss_horn_cd", {duration = 1.5})
		  self:GetParent():EmitSound("halo.attack")
		end
	end
end
function modifier_samurai_route_5:GetTexture()
	return "angel_halo"
end
function modifier_samurai_route_5:GetEffectName()
	return "particles/samurai_5.vpcf"
end


modifier_samurai_route_6 = class({})

function modifier_samurai_route_6:IsHidden() return false end
function modifier_samurai_route_6:RemoveOnDeath() return true end
function modifier_samurai_route_6:AllowIllusionDuplicate() return true end
function modifier_samurai_route_6:IsPurgable() return false end
function modifier_samurai_route_6:OnCreated()
    self.parent = self:GetParent()
    self.player = PlayerResource:GetPlayer(self.parent:GetPlayerID())
	
	Horn_StopAllMusic(self.parent)
	EmitSoundOnClient("horn.samurai_6", self.player) 
    self:PlayEffects()
end
function modifier_samurai_route_6:PlayEffects()
	-- get resources
	local particle_cast = "particles/samurai_flash2.vpcf"

	-- play particle
	local effect_cast = ParticleManager:CreateParticle( particle_cast, PATTACH_ABSORIGIN, self:GetParent() )
	ParticleManager:SetParticleControl( effect_cast, 0, self:GetParent():GetOrigin() )
	ParticleManager:SetParticleControl( effect_cast, 1, Vector( self.reincarnate_time, 0, 0 ) )
	ParticleManager:ReleaseParticleIndex( effect_cast )
end
function modifier_samurai_route_6:OnDestroy()
    StopSoundOn("horn.samurai_6", self.player) 
    
	self.ability = self:GetAbility()
	self.ability:EndCooldown()
	self.ability:StartCooldown(60)	
end

function modifier_samurai_route_6:DeclareFunctions()
    local funcs = {
                      MODIFIER_PROPERTY_PREATTACK_BONUS_DAMAGE,
		              MODIFIER_PROPERTY_PHYSICAL_ARMOR_BONUS,
		              MODIFIER_EVENT_ON_ATTACK_LANDED,
                  }

    return funcs
end
function modifier_samurai_route_6:GetModifierPhysicalArmorBonus()
    return 15
end   
function modifier_samurai_route_6:GetModifierPreAttack_BonusDamage()
    return 200
end 
function modifier_samurai_route_6:OnAttackLanded(params)
	if IsServer() then
	   self.chance = 100
	   if not self:GetParent():HasModifier("modifier_abyss_horn_cd") then
	   if params.target~=self:GetCaster() then return end
	   if params.attacker:GetTeamNumber()==params.target:GetTeamNumber() then return end
	   if RandomInt(1,100)>self.chance then return end
	      if not self:GetParent():IsStunned() then
			self:GetParent():PerformAttack(params.attacker, true,
				true,
				true,
				true,
				true,
				false,
				true)
	      end
		  self:GetParent():Heal(params.damage * 0.5, nil)
		  self:GetParent():AddNewModifier(self:GetParent(), self, "modifier_abyss_horn_cd", {duration = 1.5})
		  self:GetParent():EmitSound("halo.attack")
		
		end
	end
end
function modifier_samurai_route_6:GetTexture()
	return "angel_halo"
end
function modifier_samurai_route_6:GetEffectName()
	return "particles/samurai_6.vpcf"
end


--------------------------------------------------------------------------------------------------------
modifier_samurai_block = class({})
--------------------------------------------------------------------------------

function modifier_samurai_block:IsHidden() return false end
function modifier_samurai_block:IsDebuff() return false end
function modifier_samurai_block:IsPurgable() return false end
function modifier_samurai_block:RemoveOnDeath() return false end
function modifier_samurai_block:AllowIllusionDuplicate() return false end
--------------------------------------------------------------------------------
function modifier_samurai_block:OnCreated( kv )
	self.block_passive = 70
	self.block_chance = 50
end
function modifier_samurai_block:OnRefresh( kv )
	-- get references
	self.block_passive = 70
    self.block_chance = 50
end
--------------------------------------------------------------------------------
function modifier_samurai_block:DeclareFunctions()
	local funcs = {
                      MODIFIER_PROPERTY_PHYSICAL_CONSTANT_BLOCK,
                  }

	return funcs
end
function modifier_samurai_block:GetModifierPhysical_ConstantBlock()
    local rand = math.random(1, 100)
    
	if rand <= self.block_chance then
	  return self.block_passive
    end
end


modifier_samurai_block2 = class({})
--------------------------------------------------------------------------------

function modifier_samurai_block2:IsHidden() return false end
function modifier_samurai_block2:IsDebuff() return false end
function modifier_samurai_block2:IsPurgable() return false end
function modifier_samurai_block2:RemoveOnDeath() return false end
function modifier_samurai_block2:AllowIllusionDuplicate() return false end
--------------------------------------------------------------------------------
function modifier_samurai_block2:OnCreated( kv )
	self.block_passive = 70
	self.block_chance = 50
end
function modifier_samurai_block2:OnRefresh( kv )
	-- get references
	self.block_passive = 140
    self.block_chance = 50
end
--------------------------------------------------------------------------------
function modifier_samurai_block2:DeclareFunctions()
	local funcs = {
                      MODIFIER_PROPERTY_PHYSICAL_CONSTANT_BLOCK,
	              }

	return funcs
end
function modifier_samurai_block2:GetModifierPhysical_ConstantBlock()
    local rand = math.random(1, 100)
    
	if rand <= self.block_chance then
	  return self.block_passive
    end
end


modifier_samurai_full_counter = class({})
--------------------------------------------------------------------------------

function modifier_samurai_full_counter:IsHidden() return false end
function modifier_samurai_full_counter:IsDebuff() return false end
function modifier_samurai_full_counter:IsPurgable() return false end
function modifier_samurai_full_counter:RemoveOnDeath() return false end
function modifier_samurai_full_counter:AllowIllusionDuplicate() return false end
--------------------------------------------------------------------------------
function modifier_samurai_full_counter:OnCreated( kv )
	self.block_passive = 100
	self.block_chance = 100
end
function modifier_samurai_full_counter:OnRefresh( kv )
	-- get references
	self.block_passive = 100
    self.block_chance = 1000
end
--------------------------------------------------------------------------------

function modifier_samurai_full_counter:DeclareFunctions()
	local funcs = {
		              MODIFIER_PROPERTY_PHYSICAL_CONSTANT_BLOCK,
	              }

	return funcs
end
function modifier_samurai_full_counter:GetModifierPhysical_ConstantBlock()
    local rand = math.random(1, 100)
    
	if rand <= self.block_chance then
	  return self.block_passive
    end
end


modifier_samurai_bleed = class({})
--------------------------------------------------------------------------------
-- Classifications
function modifier_samurai_bleed:IsHidden() return false end
function modifier_samurai_bleed:IsDebuff() return true end
function modifier_samurai_bleed:IsStunDebuff() return false end
function modifier_samurai_bleed:IsPurgable() return true end
--------------------------------------------------------------------------------
-- Initializations
function modifier_samurai_bleed:OnCreated( kv )
	-- references
	local tick_damage = 100 -- special value
	self.interval = 0.5

	if IsServer() then
		-- Apply Damage	 
		self.damageTable = {
			victim = self:GetParent(),
			attacker = self:GetCaster(),
			damage = tick_damage,
			damage_type = DAMAGE_TYPE_MAGICAL,
			ability = self, --Optional.
		}

		-- Start interval
		self:StartIntervalThink( self.interval )
		self:OnIntervalThink()
	end
end
function modifier_samurai_bleed:OnRefresh( kv )
	-- references
	local tick_damage = 100 -- special value
	self.interval = 0.5

	if IsServer() then
		-- Apply Damage	 
		self.damageTable = {
			victim = self:GetParent(),
			attacker = self:GetCaster(),
			damage = tick_damage,
			damage_type = DAMAGE_TYPE_MAGICAL,
			damage_flags = DOTA_DAMAGE_FLAG_NONE, --Optional.
			ability = self, --Optional.
		}

		-- Start interval
		self:StartIntervalThink( self.interval )
		self:OnIntervalThink()

		-- Play Effects
		self.sound_target = ""
		EmitSoundOn( self.sound_target, self:GetParent() )
	end
end
function modifier_samurai_bleed:OnDestroy()
	StopSoundOn( self.sound_target, self:GetParent() )
end
--------------------------------------------------------------------------------
-- Status Effects
function modifier_samurai_bleed:CheckState()
	local state = {
	                  [MODIFIER_STATE_DISARMED] = true,
	                  [MODIFIER_STATE_INVISIBLE] = false,
	              }

	return state
end
--------------------------------------------------------------------------------
-- Interval Effects
function modifier_samurai_bleed:OnIntervalThink()
	ApplyDamage( self.damageTable )
end
--------------------------------------------------------------------------------
-- Graphics & Animations
function modifier_samurai_bleed:GetEffectName()
	return "particles/units/heroes/hero_bloodseeker/bloodseeker_rupture.vpcf"
end
function modifier_samurai_bleed:GetEffectAttachType()
	return PATTACH_ABSORIGIN_FOLLOW
end

--------------------------------------------------------------------------------
-- HELPER FUNCTIONS
--------------------------------------------------------------------------------
function Horn_StopAllMusic(hParent)
	if IsServer() and hParent then
	    local Player = PlayerResource:GetPlayer(hParent:GetPlayerID())
		for i = 1, 30 do
			StopSoundOn("star.theme_"..i, Player)
		end
		for i = 1, 6  do
			StopSoundOn("horn.hero_"..i, Player)
		end
		for i = 1, 6  do
			StopSoundOn("horn.demon_"..i, Player)
		end
		for i = 1, 6  do
			StopSoundOn("horn.samurai_"..i, Player)
		end
		for i = 1, 6  do
			StopSoundOn("spamton.theme_"..i, Player)
		end
	    for i = 1, 8  do
			StopSoundOn("new.year_theme_"..i, Player)
		end
    end
end